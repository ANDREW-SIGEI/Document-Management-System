{% extends 'base.html' %}

{% block title %}Incoming Documents - Document Management System{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
    <h1 class="h2 mb-2 mb-md-0">Incoming Documents</h1>
    <div class="d-flex gap-2">
        <a href="{{ url_for('track_document') }}" class="btn btn-info mr-2">
            <i class="fas fa-search"></i> Track Document
        </a>
        <a href="/compose?type=incoming" class="btn btn-primary">
            <i class="fas fa-plus"></i> New Incoming Document
        </a>
        <button type="button" class="btn btn-outline-primary" id="bulkActionsBtn" disabled data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            <i class="fas fa-tasks"></i> Bulk Actions
        </button>
        <div class="dropdown-menu dropdown-menu-right" aria-labelledby="bulkActionsBtn">
            <form id="bulkActionForm" action="{{ url_for('incoming_bulk_action') }}" method="post" aria-label="Bulk actions form">
                <input type="hidden" name="bulk_action" id="bulkActionType" value="" title="Bulk action type">
                <div id="selectedDocsContainer"></div>
                <button type="button" class="dropdown-item bulk-action-btn" data-action="mark_pending">
                    <i class="fas fa-clock text-warning"></i> Mark as Pending
                </button>
                <button type="button" class="dropdown-item bulk-action-btn" data-action="mark_received">
                    <i class="fas fa-check-circle text-success"></i> Mark as Received
                </button>
                <div class="dropdown-divider"></div>
                <button type="button" class="dropdown-item bulk-action-btn" data-action="print">
                    <i class="fas fa-print text-secondary"></i> Print Selected
                </button>
                <button type="button" class="dropdown-item bulk-action-btn" data-action="export">
                    <i class="fas fa-file-export text-primary"></i> Export Selected
                </button>
            </form>
        </div>
    </div>
</div>

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
    {% endfor %}
  {% endif %}
{% endwith %}

<!-- Quick Search and Filters -->
<div class="card mb-4">
    <div class="card-body">
        <form id="searchForm" action="{{ url_for('incoming') }}" method="GET">
            <div class="row">
                <div class="col-lg-8 col-md-12 mb-3 mb-lg-0">
                    <div class="input-group">
                        <input type="text" class="form-control" name="search" value="{{ search_query }}" placeholder="Search by code, sender, title or content...">
                        <div class="input-group-append">
                            <button class="btn btn-primary" type="submit" aria-label="Search">
                                <i class="fas fa-search"></i> Search
                            </button>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4 col-md-12">
                    <div class="d-flex flex-wrap">
                        <div class="input-group input-group-sm mr-2 mb-2 mb-md-0">
                            <div class="input-group-prepend">
                                <label class="input-group-text" for="statusFilter">Status</label>
                            </div>
                            <select class="custom-select" id="statusFilter" name="status" title="Filter by status">
                                <option value="All" {% if status_filter == 'All' %}selected{% endif %}>All Statuses</option>
                                <option value="Incoming" {% if status_filter == 'Incoming' %}selected{% endif %}>Incoming</option>
                                <option value="Pending" {% if status_filter == 'Pending' %}selected{% endif %}>Pending</option>
                                <option value="Received" {% if status_filter == 'Received' %}selected{% endif %}>Received</option>
                            </select>
                        </div>
                    </div>
                    <input type="hidden" name="priority" id="priorityFilter" value="{{ priority_filter }}">
                    <input type="hidden" name="sort_by" id="sortBy" value="{{ sort_by }}">
                    <input type="hidden" name="sort_order" id="sortOrder" value="{{ sort_order }}">
                    <input type="hidden" name="page" id="page" value="{{ pagination.page }}">
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Stats Cards -->
<div class="row mb-4">
    <div class="col-md-4 col-sm-6 mb-3 mb-md-0">
        <div class="card border-left-info shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-info text-uppercase mb-1">Incoming</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">{{ status_counts.Incoming }}</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-inbox fa-2x text-gray-300"></i>
                    </div>
                </div>
                <div class="mt-2">
                    <a href="{{ url_for('incoming', status='Incoming') }}" class="btn btn-sm btn-outline-info btn-block">View Only Incoming</a>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4 col-sm-6 mb-3 mb-md-0">
        <div class="card border-left-warning shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Pending</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">{{ status_counts.Pending }}</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-clock fa-2x text-gray-300"></i>
                    </div>
                </div>
                <div class="mt-2">
                    <a href="{{ url_for('incoming', status='Pending') }}" class="btn btn-sm btn-outline-warning btn-block">View Only Pending</a>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4 col-sm-6">
        <div class="card border-left-success shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Received</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">{{ status_counts.Received }}</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-check-circle fa-2x text-gray-300"></i>
                    </div>
                </div>
                <div class="mt-2">
                    <a href="{{ url_for('incoming', status='Received') }}" class="btn btn-sm btn-outline-success btn-block">View Only Received</a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Priority Filter Tabs -->
<div class="card mb-4">
    <div class="card-body p-0">
        <ul class="nav nav-pills nav-fill">
            <li class="nav-item">
                <a class="nav-link {% if priority_filter == 'All' %}active{% endif %} priority-filter" href="#" data-priority="All">
                    <i class="fas fa-list-ul mr-1"></i> All Priorities
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link {% if priority_filter == 'Urgent' %}active{% endif %} priority-filter" href="#" data-priority="Urgent">
                    <i class="fas fa-exclamation-circle text-danger mr-1"></i> Urgent
                    <span class="badge badge-pill badge-danger ml-1">{{ priority_counts.Urgent }}</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link {% if priority_filter == 'Priority' %}active{% endif %} priority-filter" href="#" data-priority="Priority">
                    <i class="fas fa-exclamation text-warning mr-1"></i> Priority
                    <span class="badge badge-pill badge-warning ml-1">{{ priority_counts.Priority }}</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link {% if priority_filter == 'Normal' %}active{% endif %} priority-filter" href="#" data-priority="Normal">
                    <i class="fas fa-file text-secondary mr-1"></i> Normal
                    <span class="badge badge-pill badge-secondary ml-1">{{ priority_counts.Normal }}</span>
                </a>
            </li>
        </ul>
    </div>
</div>

<!-- Documents Table -->
<div class="card shadow">
    <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
        <h5 class="mb-0 font-weight-bold text-primary">Document List</h5>
        <div class="btn-group btn-group-sm">
            <button type="button" class="btn btn-outline-secondary sort-btn {% if sort_by == 'date' %}active{% endif %}" data-sort="date" title="Sort by date">
                Date 
                {% if sort_by == 'date' %}
                <i class="fas fa-sort-{% if sort_order == 'desc' %}down{% else %}up{% endif %}"></i>
                {% endif %}
            </button>
            <button type="button" class="btn btn-outline-secondary sort-btn {% if sort_by == 'priority' %}active{% endif %}" data-sort="priority" title="Sort by priority">
                Priority 
                {% if sort_by == 'priority' %}
                <i class="fas fa-sort-{% if sort_order == 'desc' %}down{% else %}up{% endif %}"></i>
                {% endif %}
            </button>
            <button type="button" class="btn btn-outline-secondary sort-btn {% if sort_by == 'code' %}active{% endif %}" data-sort="code" title="Sort by code">
                Code 
                {% if sort_by == 'code' %}
                <i class="fas fa-sort-{% if sort_order == 'desc' %}down{% else %}up{% endif %}"></i>
                {% endif %}
            </button>
            <button type="button" class="btn btn-outline-secondary sort-btn {% if sort_by == 'action' %}active{% endif %}" data-sort="action" title="Sort by action">
                Action 
                {% if sort_by == 'action' %}
                <i class="fas fa-sort-{% if sort_order == 'desc' %}down{% else %}up{% endif %}"></i>
                {% endif %}
            </button>
        </div>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="bg-light">
                    <tr>
                        <th style="width: 40px;">
                            <div class="custom-control custom-checkbox">
                                <input type="checkbox" class="custom-control-input" id="selectAll" title="Select all documents">
                                <label class="custom-control-label" for="selectAll"><span class="sr-only">Select All</span></label>
                            </div>
                        </th>
                        <th>Doc. Code</th>
                        <th>Sender</th>
                        <th>Details</th>
                        <th>Required Action</th>
                        <th>Date Received</th>
                        <th>Priority</th>
                        <th>Status</th>
                        <th>Holder</th>
                        <th style="width: 120px;">Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% if documents %}
                        {% for doc in documents %}
                        <tr class="{% if doc.priority == 'Urgent' %}table-danger{% elif doc.priority == 'Priority' %}table-warning{% endif %}">
                            <td>
                                <div class="custom-control custom-checkbox">
                                    <input type="checkbox" class="custom-control-input doc-checkbox" id="doc-{{ doc.code }}" value="{{ doc.code }}" title="Select document {{ doc.code }}">
                                    <label class="custom-control-label" for="doc-{{ doc.code }}"><span class="sr-only">Select</span></label>
                                </div>
                            </td>
                            <td><a href="/document/{{ doc.code }}" class="font-weight-bold text-primary">{{ doc.code }}</a></td>
                            <td>{{ doc.sender }}</td>
                            <td>{{ doc.details }}</td>
                            <td>{{ doc.required_action }}</td>
                            <td>{{ doc.date_received if doc.date_received is string else doc.date_received.strftime('%d/%m/%Y') if doc.date_received else "N/A" }}</td>
                            <td>
                                {% if doc.priority == 'Urgent' %}
                                    <span class="badge badge-danger">{{ doc.priority }}</span>
                                {% elif doc.priority == 'Priority' %}
                                    <span class="badge badge-warning">{{ doc.priority }}</span>
                                {% else %}
                                    <span class="badge badge-secondary">{{ doc.priority }}</span>
                                {% endif %}
                            </td>
                            <td>
                                <span class="badge badge-pill {% if doc.status == 'Incoming' %}badge-info{% elif doc.status == 'Pending' %}badge-warning{% elif doc.status == 'Received' %}badge-success{% else %}badge-secondary{% endif %}">
                                    {{ doc.status }}
                                </span>
                            </td>
                            <td>{{ doc.current_holder }}</td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <a href="/document/{{ doc.code }}" class="btn btn-outline-primary" data-toggle="tooltip" title="View Details">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    <button type="button" class="btn btn-outline-info dropdown-toggle dropdown-toggle-split" data-toggle="dropdown" aria-expanded="false">
                                        <span class="sr-only">Actions</span>
                                    </button>
                                    <div class="dropdown-menu dropdown-menu-right">
                                        <form action="{{ url_for('update_incoming_status', doc_code=doc.code) }}" method="post">
                                            <button type="submit" name="status" value="Pending" class="dropdown-item {% if doc.status == 'Pending' %}disabled{% endif %}">
                                                <i class="fas fa-clock text-warning"></i> Mark as Pending
                                            </button>
                                            <button type="submit" name="status" value="Received" class="dropdown-item {% if doc.status == 'Received' %}disabled{% endif %}">
                                                <i class="fas fa-check-circle text-success"></i> Mark as Received
                                            </button>
                                            <button type="submit" name="status" value="Outgoing" class="dropdown-item {% if doc.status == 'Outgoing' %}disabled{% endif %}">
                                                <i class="fas fa-paper-plane text-info"></i> Move to Outgoing
                                            </button>
                                            <div class="dropdown-divider"></div>
                                            <button type="submit" name="status" value="Ended" class="dropdown-item {% if doc.status == 'Ended' %}disabled{% endif %}">
                                                <i class="fas fa-archive text-secondary"></i> Mark as Ended
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="10" class="text-center py-4">
                                <div class="py-5">
                                    <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                                    <h5>No incoming documents found</h5>
                                    <p class="text-muted">Start by <a href="/compose" class="text-primary">uploading a new document</a></p>
                                </div>
                            </td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>

    {% if pagination.pages > 1 %}
    <div class="card-footer bg-white">
        <nav aria-label="Document pagination">
            <ul class="pagination pagination-sm justify-content-center mb-0">
                {% if pagination.has_prev %}
                    <li class="page-item">
                        <a class="page-link" href="#" data-page="{{ pagination.prev_num }}" aria-label="Previous">
                            <span aria-hidden="true">&laquo;</span>
                        </a>
                    </li>
                {% else %}
                    <li class="page-item disabled">
                        <span class="page-link" aria-hidden="true">&laquo;</span>
                    </li>
                {% endif %}
                
                {% for page_num in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
                    {% if page_num %}
                        {% if page_num == pagination.page %}
                            <li class="page-item active">
                                <span class="page-link">{{ page_num }}</span>
                            </li>
                        {% else %}
                            <li class="page-item">
                                <a class="page-link" href="#" data-page="{{ page_num }}">{{ page_num }}</a>
                            </li>
                        {% endif %}
                    {% else %}
                        <li class="page-item disabled">
                            <span class="page-link">â€¦</span>
                        </li>
                    {% endif %}
                {% endfor %}
                
                {% if pagination.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="#" data-page="{{ pagination.next_num }}" aria-label="Next">
                            <span aria-hidden="true">&raquo;</span>
                        </a>
                    </li>
                {% else %}
                    <li class="page-item disabled">
                        <span class="page-link" aria-hidden="true">&raquo;</span>
                    </li>
                {% endif %}
            </ul>
        </nav>
    </div>
    {% endif %}
</div>

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Status filter change
    const statusFilter = document.getElementById('statusFilter');
    if (statusFilter) {
        statusFilter.addEventListener('change', function() {
            // Reset page to 1 when changing filters
            document.getElementById('page').value = 1;
            document.getElementById('searchForm').submit();
        });
    }
    
    // Priority filter buttons
    const priorityButtons = document.querySelectorAll('.priority-filter');
    priorityButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const priority = this.getAttribute('data-priority');
            document.getElementById('priorityFilter').value = priority;
            
            // Reset page to 1 when changing filters
            document.getElementById('page').value = 1;
            
            document.getElementById('searchForm').submit();
        });
    });
    
    // Sorting
    const sortButtons = document.querySelectorAll('.sort-btn');
    sortButtons.forEach(button => {
        button.addEventListener('click', function() {
            const sortBy = this.getAttribute('data-sort');
            const currentSortBy = document.getElementById('sortBy').value;
            let sortOrder = document.getElementById('sortOrder').value;
            
            if (sortBy === currentSortBy) {
                // Toggle sort order if clicking the same column
                sortOrder = sortOrder === 'asc' ? 'desc' : 'asc';
            } else {
                // Default to descending for new sort column
                sortOrder = 'desc';
            }
            
            document.getElementById('sortBy').value = sortBy;
            document.getElementById('sortOrder').value = sortOrder;
            document.getElementById('searchForm').submit();
        });
    });
    
    // Pagination
    const pageLinks = document.querySelectorAll('.page-link[data-page]');
    pageLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const page = this.getAttribute('data-page');
            document.getElementById('page').value = page;
            document.getElementById('searchForm').submit();
        });
    });
    
    // Select all checkbox
    const selectAll = document.getElementById('selectAll');
    if (selectAll) {
        selectAll.addEventListener('change', function() {
            const checkboxes = document.querySelectorAll('.doc-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
            
            updateBulkActionButton();
        });
    }
    
    // Individual checkboxes
    const checkboxes = document.querySelectorAll('.doc-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            updateBulkActionButton();
            
            // Uncheck "select all" if any checkbox is unchecked
            if (!this.checked) {
                selectAll.checked = false;
            }
            
            // Check "select all" if all checkboxes are checked
            if (document.querySelectorAll('.doc-checkbox:checked').length === checkboxes.length) {
                selectAll.checked = true;
            }
        });
    });
    
    // Bulk action buttons
    const bulkActionButtons = document.querySelectorAll('.bulk-action-btn');
    bulkActionButtons.forEach(button => {
        button.addEventListener('click', function() {
            const action = this.getAttribute('data-action');
            document.getElementById('bulkActionType').value = action;
            
            // Create hidden inputs for selected documents
            const selectedDocs = document.querySelectorAll('.doc-checkbox:checked');
            const container = document.getElementById('selectedDocsContainer');
            container.innerHTML = '';
            
            selectedDocs.forEach(checkbox => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'selected_docs';
                input.value = checkbox.value;
                container.appendChild(input);
            });
            
            document.getElementById('bulkActionForm').submit();
        });
    });
    
    function updateBulkActionButton() {
        const selectedCount = document.querySelectorAll('.doc-checkbox:checked').length;
        const bulkActionsBtn = document.getElementById('bulkActionsBtn');
        
        if (selectedCount > 0) {
            bulkActionsBtn.removeAttribute('disabled');
            bulkActionsBtn.textContent = `Bulk Actions (${selectedCount})`;
        } else {
            bulkActionsBtn.setAttribute('disabled', 'disabled');
            bulkActionsBtn.innerHTML = '<i class="fas fa-tasks"></i> Bulk Actions';
        }
    }
    
    // Initialize tooltips
    if (typeof $ !== 'undefined' && typeof $.fn.tooltip !== 'undefined') {
        $('[data-toggle="tooltip"]').tooltip();
    }
});
</script>
{% endblock %}
{% endblock %} 
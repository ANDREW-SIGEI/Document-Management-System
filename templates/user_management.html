{% extends 'layout.html' %}

{% block title %}User Management - Document Management System{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>User Management</h1>
    <div>
        <button class="btn btn-success mr-2" data-toggle="modal" data-target="#importUsersModal">
            <i class="fas fa-file-import mr-1"></i> Import Users
        </button>
        <button class="btn btn-primary" data-toggle="modal" data-target="#addUserModal">
            <i class="fas fa-user-plus mr-1"></i> Add New User
        </button>
    </div>
</div>

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
    {% endfor %}
  {% endif %}
{% endwith %}

<!-- User Search and Filters -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row mb-3">
            <div class="col-md-8">
                <div class="input-group">
                    <input type="text" id="userSearch" class="form-control" placeholder="Search users...">
                    <div class="input-group-append">
                        <button class="btn btn-primary" type="button" aria-label="Search">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="btn-group btn-group-sm w-100" role="group">
                    <button type="button" class="btn btn-outline-primary active" data-filter="all">All Users</button>
                    <button type="button" class="btn btn-outline-success" data-filter="active">Active</button>
                    <button type="button" class="btn btn-outline-danger" data-filter="inactive">Inactive</button>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-8">
                <div class="input-group">
                    <select id="bulkAction" class="form-control" aria-label="Bulk Actions">
                        <option value="">-- Bulk Actions --</option>
                        <option value="activate">Activate Users</option>
                        <option value="deactivate">Deactivate Users</option>
                        <option value="delete">Delete Users</option>
                        <option value="export">Export Users</option>
                    </select>
                    <div class="input-group-append">
                        <button class="btn btn-secondary" type="button" id="applyBulkAction">Apply</button>
                    </div>
                </div>
            </div>
            <div class="col-md-4 text-right">
                <span class="text-muted"><span id="selectedCount">0</span> users selected</span>
            </div>
        </div>
    </div>
</div>

<!-- Users List -->
<div class="card">
    <div class="card-header bg-white">
        <h5 class="mb-0">Users</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>
                            <div class="custom-control custom-checkbox">
                                <input type="checkbox" class="custom-control-input" id="selectAll" aria-label="Select all users">
                                <label class="custom-control-label" for="selectAll"></label>
                            </div>
                        </th>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Role</th>
                        <th>Department</th>
                        <th>Status</th>
                        <th>Last Active</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in users %}
                    <tr data-status="{{ 'active' if user.role else 'inactive' }}">
                        <td>
                            <div class="custom-control custom-checkbox">
                                <input type="checkbox" class="custom-control-input user-select" id="user{{ user.id }}" aria-label="Select user {{ user.username }}">
                                <label class="custom-control-label" for="user{{ user.id }}"></label>
                            </div>
                        </td>
                        <td>{{ user.id }}</td>
                        <td>
                            <img src="https://picsum.photos/30/30?random={{ loop.index }}" class="rounded-circle mr-2" alt="User">
                            {{ user.username }}
                        </td>
                        <td>{{ user.email }}</td>
                        <td>
                            <span class="badge badge-{% if user.role == 'Administrator' %}primary{% elif user.role == 'Manager' %}info{% else %}secondary{% endif %}">
                                {{ user.role if user.role else 'User' }}
                            </span>
                        </td>
                        <td>{{ user.department }}</td>
                        <td>
                            <span class="badge badge-{% if user.role %}success{% else %}danger{% endif %}">
                                {{ 'Active' if user.role else 'Inactive' }}
                            </span>
                        </td>
                        <td>{{ user.last_login.strftime('%b %d, %H:%M') if user.last_login else 'Never' }}</td>
                        <td>
                            <div class="dropdown">
                                <button class="btn btn-sm btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton-{{ user.id }}" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    Actions
                                </button>
                                <div class="dropdown-menu" aria-labelledby="dropdownMenuButton-{{ user.id }}">
                                    <a class="dropdown-item" href="{{ url_for('my_account') }}?user_id={{ user.id }}">
                                        <i class="fas fa-eye text-info"></i> View Profile
                                    </a>
                                    <a class="dropdown-item edit-user" href="#" data-toggle="modal" data-target="#editUserModal" 
                                        data-id="{{ user.id }}" 
                                        data-username="{{ user.username }}" 
                                        data-email="{{ user.email }}" 
                                        data-role="{{ user.role }}" 
                                        data-department="{{ user.department }}"
                                        data-phone="{{ user.phone }}"
                                        data-status="{{ 'active' if user.role else 'inactive' }}">
                                        <i class="fas fa-edit text-primary"></i> Edit User
                                    </a>
                                    <a class="dropdown-item reset-password" href="#" data-id="{{ user.id }}" data-username="{{ user.username }}">
                                        <i class="fas fa-key text-warning"></i> Reset Password
                                    </a>
                                    <div class="dropdown-divider"></div>
                                    <a class="dropdown-item toggle-status" href="#" data-id="{{ user.id }}" data-username="{{ user.username }}">
                                        <i class="fas fa-toggle-on text-success"></i> Toggle Status
                                    </a>
                                    <a class="dropdown-item delete-user" href="#" data-toggle="modal" data-target="#deleteUserModal" 
                                        data-id="{{ user.id }}" 
                                        data-username="{{ user.username }}">
                                        <i class="fas fa-trash text-danger"></i> Delete User
                                    </a>
                                </div>
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="9" class="text-center py-5">
                            <i class="fas fa-users text-muted mb-3" style="font-size: 3rem;"></i>
                            <p class="text-muted mb-0">No users found. Click 'Add New User' to create your first user.</p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Pagination -->
        <nav aria-label="User pagination">
            <ul class="pagination justify-content-center mt-4">
                <li class="page-item disabled">
                    <a class="page-link" href="#" tabindex="-1" aria-disabled="true">Previous</a>
                </li>
                <li class="page-item active"><a class="page-link" href="#">1</a></li>
                <li class="page-item"><a class="page-link" href="#">2</a></li>
                <li class="page-item"><a class="page-link" href="#">3</a></li>
                <li class="page-item">
                    <a class="page-link" href="#">Next</a>
                </li>
            </ul>
        </nav>
    </div>
</div>

<!-- Add User Modal -->
<div class="modal fade" id="addUserModal" tabindex="-1" role="dialog" aria-labelledby="addUserModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="addUserModalLabel">Add New User</h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form action="{{ url_for('add_user') }}" method="POST">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="username">Full Name <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text"><i class="fas fa-user"></i></span>
                                    </div>
                                    <input type="text" class="form-control" id="username" name="username" required>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="email">Email Address <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text"><i class="fas fa-envelope"></i></span>
                                    </div>
                                    <input type="email" class="form-control" id="email" name="email" required>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="phone">Phone Number</label>
                                <div class="input-group">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text"><i class="fas fa-phone"></i></span>
                                    </div>
                                    <input type="tel" class="form-control" id="phone" name="phone" placeholder="+254 7xx xxx xxx">
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="department">Department</label>
                                <div class="input-group">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text"><i class="fas fa-building"></i></span>
                                    </div>
                                    <select class="form-control" id="department" name="department">
                                        <option value="IT Department">IT Department</option>
                                        <option value="Finance">Finance</option>
                                        <option value="HR">HR</option>
                                        <option value="Marketing">Marketing</option>
                                        <option value="Sales">Sales</option>
                                        <option value="Research">Research</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="role">Role</label>
                                <div class="input-group">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text"><i class="fas fa-user-tag"></i></span>
                                    </div>
                                    <select class="form-control" id="role" name="role">
                                        <option value="User">User</option>
                                        <option value="Manager">Manager</option>
                                        <option value="Administrator">Administrator</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    <hr>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="password">Password <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text"><i class="fas fa-lock"></i></span>
                                    </div>
                                    <input type="password" class="form-control" id="password" name="password" required>
                                </div>
                                <small class="form-text text-muted">Password must be at least 6 characters</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="passwordConfirm">Confirm Password <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text"><i class="fas fa-lock"></i></span>
                                    </div>
                                    <input type="password" class="form-control" id="passwordConfirm" name="passwordConfirm" required>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle mr-2"></i> An email will be sent to the user with their login details.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="reset" class="btn btn-warning">Reset Form</button>
                    <button type="submit" class="btn btn-primary">Create User</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit User Modal -->
<div class="modal fade" id="editUserModal" tabindex="-1" role="dialog" aria-labelledby="editUserModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="editUserModalLabel">Edit User</h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form id="editUserForm" action="{{ url_for('edit_user', user_id=0) }}" method="POST">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="edit-username">Full Name <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text"><i class="fas fa-user"></i></span>
                                    </div>
                                    <input type="text" class="form-control" id="edit-username" name="username" required>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="edit-email">Email Address <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text"><i class="fas fa-envelope"></i></span>
                                    </div>
                                    <input type="email" class="form-control" id="edit-email" name="email" required>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="edit-phone">Phone Number</label>
                                <div class="input-group">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text"><i class="fas fa-phone"></i></span>
                                    </div>
                                    <input type="tel" class="form-control" id="edit-phone" name="phone" placeholder="+254 7xx xxx xxx">
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="edit-department">Department</label>
                                <div class="input-group">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text"><i class="fas fa-building"></i></span>
                                    </div>
                                    <select class="form-control" id="edit-department" name="department">
                                        <option value="IT Department">IT Department</option>
                                        <option value="Finance">Finance</option>
                                        <option value="HR">HR</option>
                                        <option value="Marketing">Marketing</option>
                                        <option value="Sales">Sales</option>
                                        <option value="Research">Research</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="edit-role">Role</label>
                                <div class="input-group">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text"><i class="fas fa-user-tag"></i></span>
                                    </div>
                                    <select class="form-control" id="edit-role" name="role">
                                        <option value="User">User</option>
                                        <option value="Manager">Manager</option>
                                        <option value="Administrator">Administrator</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="edit-status">Status</label>
                                <div class="input-group">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text"><i class="fas fa-toggle-on"></i></span>
                                    </div>
                                    <select class="form-control" id="edit-status" name="status">
                                        <option value="active">Active</option>
                                        <option value="inactive">Inactive</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete User Modal -->
<div class="modal fade" id="deleteUserModal" tabindex="-1" role="dialog" aria-labelledby="deleteUserModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteUserModalLabel">Delete User</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete <strong id="delete-username"></strong>? This action cannot be undone.</p>
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle mr-2"></i> All data associated with this user will be permanently deleted.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <form id="deleteUserForm" action="{{ url_for('delete_user', user_id=0) }}" method="POST">
                    <button type="submit" class="btn btn-danger">Delete User</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Import Users Modal -->
<div class="modal fade" id="importUsersModal" tabindex="-1" role="dialog" aria-labelledby="importUsersModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="importUsersModalLabel">Import Users</h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form action="{{ url_for('import_users') }}" method="POST" enctype="multipart/form-data">
                <div class="modal-body">
                    <p>Import multiple users at once using a CSV file. The file should contain the following columns:</p>
                    <div class="alert alert-info small">
                        <strong>Required columns:</strong> Name, Email, Password<br>
                        <strong>Optional columns:</strong> Phone, Department, Role
                    </div>
                    
                    <div class="form-group">
                        <label for="csvFile">Upload CSV File</label>
                        <div class="custom-file">
                            <input type="file" class="custom-file-input" id="csvFile" name="csvFile" accept=".csv" required>
                            <label class="custom-file-label" for="csvFile">Choose file</label>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <div class="custom-control custom-checkbox">
                            <input type="checkbox" class="custom-control-input" id="skipHeader" name="skipHeader" checked>
                            <label class="custom-control-label" for="skipHeader">Skip first row (header row)</label>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <div class="custom-control custom-checkbox">
                            <input type="checkbox" class="custom-control-input" id="sendEmails" name="sendEmails">
                            <label class="custom-control-label" for="sendEmails">Send welcome emails to imported users</label>
                        </div>
                    </div>
                    
                    <a href="#" class="btn btn-sm btn-outline-secondary" id="downloadTemplate">
                        <i class="fas fa-download mr-1"></i> Download Template
                    </a>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Import Users</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    // User search functionality
    $('#userSearch').on('keyup', function() {
        var value = $(this).val().toLowerCase();
        $('table tbody tr').filter(function() {
            $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1);
        });
    });
    
    // Status filter
    $('.btn-group button').on('click', function() {
        var filter = $(this).data('filter');
        
        // UI - active button
        $('.btn-group button').removeClass('active');
        $(this).addClass('active');
        
        // Filter table
        if (filter === 'all') {
            $('table tbody tr').show();
        } else {
            $('table tbody tr').hide();
            $('table tbody tr[data-status="' + filter + '"]').show();
        }
    });
    
    // Select all checkboxes
    $('#selectAll').change(function() {
        $('.user-select').prop('checked', $(this).prop('checked'));
        updateSelectedCount();
    });
    
    // Update selected count when individual checkboxes change
    $('.user-select').change(function() {
        updateSelectedCount();
    });
    
    // Function to update selected count
    function updateSelectedCount() {
        var count = $('.user-select:checked').length;
        $('#selectedCount').text(count);
    }
    
    // Apply bulk action
    $('#applyBulkAction').click(function() {
        var action = $('#bulkAction').val();
        var selectedUsers = $('.user-select:checked');
        
        if (action === '') {
            alert('Please select an action to perform');
            return;
        }
        
        if (selectedUsers.length === 0) {
            alert('Please select at least one user');
            return;
        }
        
        // Collect selected user IDs
        var userIds = [];
        selectedUsers.each(function() {
            userIds.push($(this).attr('id').replace('user', ''));
        });
        
        // Confirm action
        var confirmMessage = '';
        switch(action) {
            case 'activate':
                confirmMessage = 'Are you sure you want to activate ' + userIds.length + ' users?';
                break;
            case 'deactivate':
                confirmMessage = 'Are you sure you want to deactivate ' + userIds.length + ' users?';
                break;
            case 'delete':
                confirmMessage = 'Are you sure you want to DELETE ' + userIds.length + ' users? This cannot be undone!';
                break;
            case 'export':
                confirmMessage = 'Export ' + userIds.length + ' users to CSV?';
                break;
        }
        
        if (confirm(confirmMessage)) {
            // Create and submit a form with the action and user IDs
            var form = document.createElement('form');
            form.method = 'POST';
            form.action = '/bulk_user_action';
            
            // Add action
            var actionInput = document.createElement('input');
            actionInput.type = 'hidden';
            actionInput.name = 'action';
            actionInput.value = action;
            form.appendChild(actionInput);
            
            // Add user IDs
            userIds.forEach(function(id) {
                var input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'user_ids';
                input.value = id;
                form.appendChild(input);
            });
            
            document.body.appendChild(form);
            form.submit();
        }
    });
    
    // Edit user - populate modal
    $('.edit-user').click(function() {
        var id = $(this).data('id');
        var username = $(this).data('username');
        var email = $(this).data('email');
        var role = $(this).data('role');
        var department = $(this).data('department');
        var phone = $(this).data('phone') || '';
        var status = (role && role !== '') ? 'active' : 'inactive';
        
        $('#edit-username').val(username);
        $('#edit-email').val(email);
        $('#edit-phone').val(phone);
        $('#edit-role').val(role || 'User');
        $('#edit-department').val(department || 'IT Department');
        $('#edit-status').val(status);
        
        $('#editUserForm').attr('action', '/edit_user/' + id);
    });
    
    // Delete user - populate modal
    $('.delete-user').click(function() {
        var id = $(this).data('id');
        var username = $(this).data('username');
        
        $('#delete-username').text(username);
        $('#deleteUserForm').attr('action', '/delete_user/' + id);
    });
    
    // Reset password handler
    $('.reset-password').click(function() {
        var userId = $(this).data('id');
        var username = $(this).data('username');
        
        if (confirm('Are you sure you want to reset the password for ' + username + '?')) {
            // Create a form and submit it
            var form = document.createElement('form');
            form.method = 'POST';
            form.action = '/reset_password/' + userId;
            document.body.appendChild(form);
            form.submit();
        }
    });
    
    // Toggle status handler
    $('.toggle-status').click(function() {
        var userId = $(this).data('id');
        var username = $(this).data('username');
        
        if (confirm('Are you sure you want to change the status for ' + username + '?')) {
            // Create a form and submit it
            var form = document.createElement('form');
            form.method = 'POST';
            form.action = '/toggle_user_status/' + userId;
            document.body.appendChild(form);
            form.submit();
        }
    });
    
    // Validation for password confirmation
    $('#addUserModal form').submit(function(e) {
        var password = $('#password').val();
        var confirm = $('#passwordConfirm').val();
        
        if (password !== confirm) {
            e.preventDefault();
            alert('Passwords do not match');
        }
        
        if (password.length < 6) {
            e.preventDefault();
            alert('Password must be at least 6 characters long');
        }
    });
    
    // Handle custom file input
    $('.custom-file-input').on('change', function() {
        var fileName = $(this).val().split('\\').pop();
        $(this).next('.custom-file-label').html(fileName);
    });
    
    // Template download
    $('#downloadTemplate').click(function(e) {
        e.preventDefault();
        
        // Create CSV content
        var csvContent = "Name,Email,Password,Phone,Department,Role\n";
        csvContent += "John Doe,john.doe@example.com,password123,+1234567890,IT Department,User\n";
        csvContent += "Jane Smith,jane.smith@example.com,password123,+1234567891,Finance,Manager\n";
        
        // Create blob and download
        var blob = new Blob([csvContent], { type: 'text/csv' });
        var link = document.createElement('a');
        link.href = window.URL.createObjectURL(blob);
        link.download = "user_import_template.csv";
        link.click();
    });
});
</script>
{% endblock %} 
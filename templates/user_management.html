{% extends 'base.html' %}

{% block title %}User Management - Document Management System{% endblock %}

{% block content %}
<!-- Header with buttons -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3">User Management</h1>
    <div class="btn-group">
        <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#importUsersModal" title="Import Users">
            <i class="fas fa-file-import"></i> Import Users
        </button>
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addUserModal" title="Add New User">
            <i class="fas fa-user-plus"></i> Add New User
        </button>
        <button type="button" class="btn btn-outline-secondary" id="exportAllUsers" title="Export All Users">
            <i class="fas fa-file-export"></i> Export All Users
        </button>
        <a href="{{ url_for('logout') }}" class="btn btn-danger" title="Logout">
            <i class="fas fa-sign-out-alt"></i> Logout
        </a>
    </div>
</div>

<!-- Flash messages -->
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    {% endfor %}
  {% endif %}
{% endwith %}

<!-- User statistics cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card border-left-primary shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Total Users</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">{{ users|length }}</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-users fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-left-success shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Active Users</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">{{ users|selectattr('status', 'equalto', 'active')|list|length }}</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-user-check fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-left-warning shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Inactive Users</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">{{ users|selectattr('status', 'equalto', 'inactive')|list|length }}</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-user-times fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-left-danger shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">Admin Users</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">{{ users|selectattr('role', 'equalto', 'Administrator')|list|length }}</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-user-shield fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- User search and filter section -->
<div class="row mb-4">
    <div class="col-md-8">
        <div class="input-group">
            <span class="input-group-text bg-primary text-white"><i class="fas fa-search"></i></span>
            <input type="text" class="form-control" id="userSearch" placeholder="Search for users by name, email, or department" aria-label="Search for users">
        </div>
    </div>
    <div class="col-md-4">
        <div class="btn-group w-100">
            <button type="button" class="btn btn-outline-secondary user-filter active" data-filter="all" title="Show All Users">All</button>
            <button type="button" class="btn btn-outline-success user-filter" data-filter="active" title="Show Active Users">Active</button>
            <button type="button" class="btn btn-outline-warning user-filter" data-filter="inactive" title="Show Inactive Users">Inactive</button>
        </div>
    </div>
</div>

<!-- Quick Add User Card -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card shadow">
            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                <h6 class="m-0 font-weight-bold text-primary">Quick Add User</h6>
                <div class="dropdown no-arrow">
                    <a class="dropdown-toggle" href="#" role="button" id="quickAddDropdown" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Quick add options">
                        <i class="fas fa-ellipsis-v fa-sm fa-fw text-gray-400"></i>
                    </a>
                    <div class="dropdown-menu dropdown-menu-end shadow animated--fade-in" aria-labelledby="quickAddDropdown">
                        <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#addUserModal">Full Add User Form</a>
                        <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#importUsersModal">Import Users</a>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <form id="quickAddUserForm" action="/quick_add_user" method="post" class="mt-3">
                    <div class="form-group mb-3">
                        <label for="quickName">Full Name</label>
                        <input type="text" class="form-control" id="quickName" name="name" placeholder="Enter full name" required>
                    </div>
                    <div class="form-group mb-3">
                        <label for="quickEmail">Email</label>
                        <input type="email" class="form-control" id="quickEmail" name="email" placeholder="Enter email" required>
                    </div>
                    <div class="form-group mb-3">
                        <label for="quickDepartment">Department</label>
                        <select class="form-select" id="quickDepartment" name="department" required title="Department" aria-label="Department">
                            <option value="" disabled selected>Select department</option>
                            <option value="IT">IT</option>
                            <option value="HR">HR</option>
                            <option value="Finance">Finance</option>
                            <option value="Laboratory">Laboratory</option>
                            <option value="Research">Research</option>
                        </select>
                    </div>
                    <div class="form-group mb-3">
                        <label for="quickPassword">Password</label>
                        <div class="input-group mb-3">
                            <input type="password" class="form-control" id="quickPassword" name="password" placeholder="Enter password" title="Password" aria-label="Password">
                            <button class="btn btn-outline-secondary toggle-password" type="button" id="toggleQuickPassword" aria-label="Toggle password visibility" title="Show/Hide Password">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>
                    <div class="d-flex align-items-end mb-3">
                        <button type="submit" class="btn btn-success w-100" title="Add User">
                            <i class="fas fa-user-plus"></i> Add User
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Users List -->
<div class="card shadow mb-4">
    <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
        <h6 class="m-0 font-weight-bold text-primary">Users List</h6>
        <div class="dropdown">
            <button class="btn btn-sm btn-outline-primary dropdown-toggle" type="button" id="bulkActionsDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                Bulk Actions
            </button>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="bulkActionsDropdown">
                <li><a class="dropdown-item bulk-action" href="#" data-action="activate"><i class="fas fa-check-circle me-1 text-success"></i> Activate Users</a></li>
                <li><a class="dropdown-item bulk-action" href="#" data-action="deactivate"><i class="fas fa-times-circle me-1 text-warning"></i> Deactivate Users</a></li>
                <li><a class="dropdown-item bulk-action" href="#" data-action="delete"><i class="fas fa-trash me-1 text-danger"></i> Delete Users</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item bulk-action" href="#" data-action="export"><i class="fas fa-file-export me-1 text-primary"></i> Export Users</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item bulk-action" href="#" data-action="assign-role" data-bs-toggle="modal" data-bs-target="#assignRoleModal"><i class="fas fa-user-tag me-1 text-info"></i> Assign Role</a></li>
                <li><a class="dropdown-item bulk-action" href="#" data-action="assign-department" data-bs-toggle="modal" data-bs-target="#assignDepartmentModal"><i class="fas fa-building me-1 text-secondary"></i> Assign Department</a></li>
                <li><a class="dropdown-item bulk-action" href="#" data-action="send-notification" data-bs-toggle="modal" data-bs-target="#sendNotificationModal"><i class="fas fa-bell me-1 text-primary"></i> Send Notification</a></li>
            </ul>
        </div>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-bordered table-hover" id="usersTable" width="100%" cellspacing="0">
                <thead>
                    <tr>
                        <th width="5%">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="selectAllUsers" title="Select all users" aria-label="Select all users">
                                <label class="form-check-label" for="selectAllUsers">Select All</label>
                            </div>
                        </th>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Department</th>
                        <th>Role</th>
                        <th>Status</th>
                        <th>Last Login</th>
                        <th width="10%">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in users %}
                    <tr class="user-row" data-user-id="{{ user.id }}" data-status="{{ user.status }}">
                        <td>
                            <div class="form-check">
                                <input class="form-check-input user-checkbox" type="checkbox" id="userCheck{{ user.id }}" value="{{ user.id }}" title="Select user {{ user.username }}" aria-label="Select user {{ user.username }}">
                                <label class="form-check-label" for="userCheck{{ user.id }}"><span class="visually-hidden">Select {{ user.username }}</span></label>
                            </div>
                        </td>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="flex-shrink-0">
                                    <div class="avatar-container">
                                        <img class="avatar-img" src="{{ url_for('static', filename='images/user.png') }}" alt="User Avatar" onerror="this.onerror=null; this.classList.add('error');">
                                        <div class="avatar-circle">
                                            <span class="initials">{{ user.username[:2].upper() }}</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="ms-3">
                                    <!-- Commented out user profile link -->
                                    <a href="#">{{ user.username }}</a>
                                    <div class="small text-muted">
                                        {% if user.login_activities %}
                                            {{ user.login_activities|length }} logins
                                        {% else %}
                                            No logins recorded
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td>{{ user.email }}</td>
                        <td>{{ user.department }}</td>
                        <td>
                            {% if user.role == 'Administrator' %}
                                <span class="badge bg-danger">{{ user.role }}</span>
                            {% elif user.role == 'Manager' %}
                                <span class="badge bg-warning text-dark">{{ user.role }}</span>
                            {% elif user.role == 'Lead Scientist' %}
                                <span class="badge bg-info text-dark">{{ user.role }}</span>
                            {% else %}
                                <span class="badge bg-secondary">{{ user.role }}</span>
                            {% endif %}
                        </td>
                        <td>
                            <!-- User status - since it's not in the model, display a default active status -->
                            <span class="badge bg-success">Active</span>
                        </td>
                        <td data-sort="{{ user.last_login }}">
                            {% if user.last_login %}
                                <span data-bs-toggle="tooltip" data-bs-placement="top" title="{{ user.last_login }}">
                                    {% if user.last_login is string %}
                                        {{ user.last_login }}
                                    {% else %}
                                        Recently
                                    {% endif %}
                                </span>
                            {% else %}
                                Never
                            {% endif %}
                        </td>
                        <td>
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                    Actions
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <!-- Commented out user profile link -->
                                    <li><a class="dropdown-item" href="#"><i class="fas fa-user me-1 text-primary"></i> View Profile</a></li>
                                    <li><a class="dropdown-item edit-user" href="#" data-bs-toggle="modal" data-bs-target="#editUserModal" data-user-id="{{ user.id }}" data-user-name="{{ user.username }}"><i class="fas fa-edit me-1 text-info"></i> Edit User</a></li>
                                    <li><a class="dropdown-item reset-password" href="#" data-user-id="{{ user.id }}"><i class="fas fa-key me-1 text-warning"></i> Reset Password</a></li>
                                    <li><a class="dropdown-item send-notification" href="#" data-bs-toggle="modal" data-bs-target="#sendNotificationModal" data-user-id="{{ user.id }}" data-user-name="{{ user.username }}"><i class="fas fa-bell me-1 text-primary"></i> Send Notification</a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li>
                                        <a class="dropdown-item toggle-status" href="#" data-user-id="{{ user.id }}" data-current-status="active">
                                            <i class="fas fa-user-times me-1 text-warning"></i> Deactivate User
                                        </a>
                                    </li>
                                    <li><a class="dropdown-item delete-user" href="#" data-bs-toggle="modal" data-bs-target="#deleteUserModal" data-user-id="{{ user.id }}" data-user-name="{{ user.username }}"><i class="fas fa-trash me-1 text-danger"></i> Delete User</a></li>
                                </ul>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Pagination -->
        <nav aria-label="User pagination">
            <ul class="pagination justify-content-center">
                <li class="page-item disabled">
                    <a class="page-link" href="#" tabindex="-1" aria-disabled="true">Previous</a>
                </li>
                <li class="page-item active"><a class="page-link" href="#">1</a></li>
                <li class="page-item"><a class="page-link" href="#">2</a></li>
                <li class="page-item"><a class="page-link" href="#">3</a></li>
                <li class="page-item">
                    <a class="page-link" href="#">Next</a>
                </li>
            </ul>
        </nav>
    </div>
</div>

<!-- Modals -->
<!-- Add User Modal -->
<div class="modal fade" id="addUserModal" tabindex="-1" aria-labelledby="addUserModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addUserModalLabel">Add New User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addUserForm" action="/add-user" method="POST">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="addUserFullName" class="form-label">Full Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="addUserFullName" name="fullName" required>
                            <div class="invalid-feedback">Full name is required</div>
                        </div>
                        <div class="col-md-6">
                            <label for="addUserEmail" class="form-label">Email Address <span class="text-danger">*</span></label>
                            <input type="email" class="form-control" id="addUserEmail" name="email" required>
                            <div class="invalid-feedback">Valid email is required</div>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="addUserPhone" class="form-label">Phone Number</label>
                            <input type="text" class="form-control" id="addUserPhone" name="phone" placeholder="+254...">
                        </div>
                        <div class="col-md-6">
                            <label for="addUserDepartment" class="form-label">Department <span class="text-danger">*</span></label>
                            <select class="form-select" id="addUserDepartment" name="department" required>
                                {% for department in departments %}
                                <option value="{{ department }}">{{ department }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="addUserRole" class="form-label">Role <span class="text-danger">*</span></label>
                            <select class="form-select" id="addUserRole" name="role" required>
                                {% for role in roles %}
                                <option value="{{ role }}">{{ role }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label d-block">Status</label>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="addUserStatus" name="status" checked>
                                <label class="form-check-label" for="addUserStatus">Active</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="addUserPassword" class="form-label">Password <span class="text-danger">*</span></label>
                            <div class="input-group mb-3">
                                <input type="password" class="form-control" id="addUserPassword" name="password" required placeholder="Enter password" title="Password" aria-label="Password">
                                <button class="btn btn-outline-secondary" type="button" id="togglePassword">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                            <div class="invalid-feedback">Password must be at least 6 characters</div>
                        </div>
                        <div class="col-md-6">
                            <label for="addUserConfirmPassword" class="form-label">Confirm Password <span class="text-danger">*</span></label>
                            <div class="input-group mb-3">
                                <input type="password" class="form-control" id="addUserConfirmPassword" name="confirm_password" required placeholder="Confirm password" title="Confirm Password" aria-label="Confirm Password">
                                <button class="btn btn-outline-secondary" type="button" id="toggleConfirmPassword">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                            <div class="invalid-feedback" id="passwordMismatch">Passwords don't match</div>
                        </div>
                    </div>
                    
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="sendWelcome" name="sendWelcome" checked>
                        <label class="form-check-label" for="sendWelcome">Send welcome email with login details</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="addUserForm" class="btn btn-primary">Create User</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit User Modal -->
<div class="modal fade" id="editUserModal" tabindex="-1" aria-labelledby="editUserModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editUserModalLabel">Edit User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editUserForm" action="/edit-user/0" method="POST">
                    <input type="hidden" id="editUserId" name="user_id" value="">
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="editUserFullName" class="form-label">Full Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="editUserFullName" name="fullName" required>
                            <div class="invalid-feedback">Full name is required</div>
                        </div>
                        <div class="col-md-6">
                            <label for="editUserEmail" class="form-label">Email Address <span class="text-danger">*</span></label>
                            <input type="email" class="form-control" id="editUserEmail" name="email" required>
                            <div class="invalid-feedback">Valid email is required</div>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="editUserPhone" class="form-label">Phone Number</label>
                            <input type="text" class="form-control" id="editUserPhone" name="phone" placeholder="+254...">
                        </div>
                        <div class="col-md-6">
                            <label for="editUserDepartment" class="form-label">Department <span class="text-danger">*</span></label>
                            <select class="form-select" id="editUserDepartment" name="department" required>
                                {% for department in departments %}
                                <option value="{{ department }}">{{ department }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="editUserRole" class="form-label">Role <span class="text-danger">*</span></label>
                            <select class="form-select" id="editUserRole" name="role" required>
                                {% for role in roles %}
                                <option value="{{ role }}">{{ role }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label d-block">Status</label>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="editUserStatus" name="status">
                                <label class="form-check-label" for="editUserStatus">Active</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="notifyUser" name="notifyUser" checked>
                        <label class="form-check-label" for="notifyUser">Notify user about changes</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="editUserForm" class="btn btn-primary">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete User Modal -->
<div class="modal fade" id="deleteUserModal" tabindex="-1" aria-labelledby="deleteUserModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteUserModalLabel">Delete User</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="deleteUserForm" action="/delete_user/0" method="POST">
                    <input type="hidden" id="deleteUserId" name="user_id" value="">
                    
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Warning:</strong> You are about to delete the user "<span id="deleteUserName"></span>".
                        This action cannot be undone.
                    </div>
                    
                    <p>All data associated with this user will be permanently deleted. This includes:</p>
                    <ul>
                        <li>User profile and personal information</li>
                        <li>Login history and activity logs</li>
                        <li>User-specific settings and preferences</li>
                    </ul>
                    
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="confirmDelete" name="confirmDelete" required>
                        <label class="form-check-label" for="confirmDelete">
                            I understand this action is permanent and cannot be undone
                        </label>
                        <div class="invalid-feedback">You must confirm deletion</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="deleteUserForm" class="btn btn-danger">Delete User</button>
            </div>
        </div>
    </div>
</div>

<!-- Import Users Modal -->
<div class="modal fade" id="importUsersModal" tabindex="-1" aria-labelledby="importUsersModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="importUsersModalLabel">Import Users</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="importUsersForm" action="/import_users" method="POST" enctype="multipart/form-data">
                    <div class="mb-4">
                        <h6 class="fw-bold">CSV File Format</h6>
                        <p>Please ensure your CSV file includes the following columns:</p>
                        
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered">
                                <thead class="table-light">
                                    <tr>
                                        <th>Column</th>
                                        <th>Required</th>
                                        <th>Description</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>Full Name</td>
                                        <td><span class="badge bg-danger">Required</span></td>
                                        <td>User's complete name</td>
                                    </tr>
                                    <tr>
                                        <td>Email</td>
                                        <td><span class="badge bg-danger">Required</span></td>
                                        <td>Valid email address (must be unique)</td>
                                    </tr>
                                    <tr>
                                        <td>Phone</td>
                                        <td><span class="badge bg-secondary">Optional</span></td>
                                        <td>Phone number with country code</td>
                                    </tr>
                                    <tr>
                                        <td>Department</td>
                                        <td><span class="badge bg-secondary">Optional</span></td>
                                        <td>Must match existing department name</td>
                                    </tr>
                                    <tr>
                                        <td>Role</td>
                                        <td><span class="badge bg-secondary">Optional</span></td>
                                        <td>Must match existing role name</td>
                                    </tr>
                                    <tr>
                                        <td>Password</td>
                                        <td><span class="badge bg-secondary">Optional</span></td>
                                        <td>If empty, a random password will be generated</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="d-grid gap-2 d-md-flex justify-content-md-start mb-3">
                            <button type="button" class="btn btn-sm btn-outline-primary" id="downloadTemplate">
                                <i class="fas fa-download me-1"></i> Download Template
                            </button>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="csvFile" class="form-label">Upload CSV File <span class="text-danger">*</span></label>
                        <input type="file" class="form-control" id="csvFile" name="csvFile" accept=".csv" required aria-label="Upload CSV file">
                        <div class="form-text">Maximum file size: 5MB</div>
                    </div>
                    
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="skipHeader" name="skipHeader" aria-label="Skip header row">
                        <label class="form-check-label" for="skipHeader">Skip header row</label>
                    </div>
                    
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="sendWelcomeEmails" name="sendWelcome" checked>
                        <label class="form-check-label" for="sendWelcomeEmails">Send welcome emails with login details</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="importUsersForm" class="btn btn-primary">Import Users</button>
            </div>
        </div>
    </div>
</div>

<!-- Assign Role Modal -->
<div class="modal fade" id="assignRoleModal" tabindex="-1" aria-labelledby="assignRoleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="assignRoleModalLabel">Assign Role</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="assignRoleForm" action="/bulk_user_action" method="POST">
                    <input type="hidden" name="action" value="assign-role">
                    <input type="hidden" id="roleUserIds" name="user_ids">
                    
                    <div class="mb-3">
                        <label for="assignRole" class="form-label">Role <span class="text-danger">*</span></label>
                        <select class="form-select" id="assignRole" name="role" required>
                            {% for role in roles %}
                            <option value="{{ role }}">{{ role }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="notifyRoleUsers" name="notifyUsers" checked>
                        <label class="form-check-label" for="notifyRoleUsers">Notify users about role change</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="assignRoleForm" class="btn btn-primary">Assign Role</button>
            </div>
        </div>
    </div>
</div>

<!-- Assign Department Modal -->
<div class="modal fade" id="assignDepartmentModal" tabindex="-1" aria-labelledby="assignDepartmentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="assignDepartmentModalLabel">Assign Department</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="assignDepartmentForm" action="/bulk_user_action" method="POST">
                    <input type="hidden" name="action" value="assign-department">
                    <input type="hidden" id="departmentUserIds" name="user_ids">
                    
                    <div class="mb-3">
                        <label for="assignDepartment" class="form-label">Department <span class="text-danger">*</span></label>
                        <select class="form-select" id="assignDepartment" name="department" required>
                            {% for department in departments %}
                            <option value="{{ department }}">{{ department }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="notifyDepartmentUsers" name="notifyUsers" checked>
                        <label class="form-check-label" for="notifyDepartmentUsers">Notify users about department change</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="assignDepartmentForm" class="btn btn-primary">Assign Department</button>
            </div>
        </div>
    </div>
</div>

<!-- Send Notification Modal -->
<div class="modal fade" id="sendNotificationModal" tabindex="-1" aria-labelledby="sendNotificationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="notificationModalTitle">Send Notification</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="sendNotificationForm" action="/send_notification/0" method="POST">
                    <input type="hidden" id="notificationUserIds" name="userIds">
                    
                    <div class="mb-3">
                        <label for="notificationType" class="form-label">Notification Type <span class="text-danger">*</span></label>
                        <select class="form-select" id="notificationType" name="notificationType" required>
                            <option value="info">Information</option>
                            <option value="warning">Warning</option>
                            <option value="success">Success</option>
                            <option value="danger">Important</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="notificationMessage" class="form-label">Message <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="notificationMessage" name="message" rows="4" required></textarea>
                        <div class="invalid-feedback">Please enter a notification message</div>
                    </div>
                    
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="sendEmailNotification" name="sendEmail" checked>
                        <label class="form-check-label" for="sendEmailNotification">Also send as email</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="sendNotificationForm" class="btn btn-primary">Send Notification</button>
            </div>
        </div>
    </div>
</div>

<!-- View User Modal -->
<div class="modal fade" id="viewUserModal" tabindex="-1" aria-labelledby="viewUserModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="viewUserModalLabel"><i class="fas fa-user me-2"></i>User Profile</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-4 text-center mb-3">
                        <div class="avatar-container mb-3">
                            <img class="avatar-img" src="{{ url_for('static', filename='images/user.png') }}" alt="User Avatar">
                            <div class="avatar-circle">
                                <span id="viewUserInitials">JD</span>
                            </div>
                        </div>
                        <h5 id="viewUserName" class="mb-1">John Doe</h5>
                        <p id="viewUserRole" class="text-muted small mb-2">Admin</p>
                        <p id="viewUserDepartment" class="badge bg-primary mb-0">Laboratory</p>
                    </div>
                    <div class="col-md-8">
                        <h6 class="border-bottom pb-2 mb-3">Contact Information</h6>
                        <div class="row mb-2">
                            <div class="col-sm-4 text-muted">Email:</div>
                            <div class="col-sm-8" id="viewUserEmail">john.doe@example.com</div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-sm-4 text-muted">Phone:</div>
                            <div class="col-sm-8" id="viewUserPhone">+1234567890</div>
                        </div>
                        <h6 class="border-bottom pb-2 mb-3 mt-4">Account Information</h6>
                        <div class="row mb-2">
                            <div class="col-sm-4 text-muted">User ID:</div>
                            <div class="col-sm-8" id="viewUserId">1001</div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-sm-4 text-muted">Created:</div>
                            <div class="col-sm-8" id="viewUserCreated">January 15, 2023</div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-sm-4 text-muted">Last Login:</div>
                            <div class="col-sm-8" id="viewUserLastLogin">Today at 09:45 AM</div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-sm-4 text-muted">Status:</div>
                            <div class="col-sm-8" id="viewUserStatusText">Active</div>
                        </div>
                    </div>
                </div>
                <div class="row mt-4">
                    <div class="col-12">
                        <h6 class="border-bottom pb-2 mb-3">Recent Activities</h6>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Time</th>
                                        <th>Activity</th>
                                        <th>Details</th>
                                    </tr>
                                </thead>
                                <tbody id="userActivitiesTable">
                                    <tr>
                                        <td>Today at 09:45 AM</td>
                                        <td>Login</td>
                                        <td>Successful login from 192.168.1.1</td>
                                    </tr>
                                    <tr>
                                        <td>Yesterday at 05:30 PM</td>
                                        <td>Logout</td>
                                        <td>Session ended</td>
                                    </tr>
                                    <tr>
                                        <td>Yesterday at 02:15 PM</td>
                                        <td>Data Entry</td>
                                        <td>Added 5 new sample records</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="editUserBtn"><i class="fas fa-user-edit me-2"></i>Edit User</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize tooltips and popovers
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.forEach(function(tooltipTriggerEl) {
        new bootstrap.Tooltip(tooltipTriggerEl);
    });

    // Password visibility toggle for quick add form
    document.getElementById('toggleQuickPassword').addEventListener('click', function() {
        var passwordField = document.getElementById('quickPassword');
        var icon = this.querySelector('i');
        
        if (passwordField.type === 'password') {
            passwordField.type = 'text';
            icon.classList.remove('fa-eye');
            icon.classList.add('fa-eye-slash');
        } else {
            passwordField.type = 'password';
            icon.classList.remove('fa-eye-slash');
            icon.classList.add('fa-eye');
        }
    });

    // Password visibility toggle for add user form
    document.getElementById('togglePassword').addEventListener('click', function() {
        var passwordField = document.getElementById('addUserPassword');
        var icon = this.querySelector('i');
        
        if (passwordField.type === 'password') {
            passwordField.type = 'text';
            icon.classList.remove('fa-eye');
            icon.classList.add('fa-eye-slash');
        } else {
            passwordField.type = 'password';
            icon.classList.remove('fa-eye-slash');
            icon.classList.add('fa-eye');
        }
    });

    // Password visibility toggle for confirm password
    document.getElementById('toggleConfirmPassword').addEventListener('click', function() {
        var passwordField = document.getElementById('addUserConfirmPassword');
        var icon = this.querySelector('i');
        
        if (passwordField.type === 'password') {
            passwordField.type = 'text';
            icon.classList.remove('fa-eye');
            icon.classList.add('fa-eye-slash');
        } else {
            passwordField.type = 'password';
            icon.classList.remove('fa-eye-slash');
            icon.classList.add('fa-eye');
        }
    });

    // Form validation for Quick Add User
    document.getElementById('quickAddUserForm').addEventListener('submit', function(e) {
        var nameField = document.getElementById('quickName');
        var emailField = document.getElementById('quickEmail');
        var passwordField = document.getElementById('quickPassword');
        var isValid = true;

        // Simple validation
        if (!nameField.value.trim()) {
            nameField.classList.add('is-invalid');
            isValid = false;
        } else {
            nameField.classList.remove('is-invalid');
        }

        if (!emailField.value.trim() || !emailField.value.includes('@')) {
            emailField.classList.add('is-invalid');
            isValid = false;
        } else {
            emailField.classList.remove('is-invalid');
        }

        if (passwordField.value.trim() && passwordField.value.length < 6) {
            passwordField.classList.add('is-invalid');
            isValid = false;
        } else {
            passwordField.classList.remove('is-invalid');
        }

        if (!isValid) {
            e.preventDefault();
        }
    });

    // Form validation for Add User
    document.getElementById('addUserForm').addEventListener('submit', function(e) {
        var fullNameField = document.getElementById('addUserFullName');
        var emailField = document.getElementById('addUserEmail');
        var passwordField = document.getElementById('addUserPassword');
        var confirmPasswordField = document.getElementById('addUserConfirmPassword');
        var departmentField = document.getElementById('addUserDepartment');
        var roleField = document.getElementById('addUserRole');
        var isValid = true;

        // Validate required fields
        if (!fullNameField.value.trim()) {
            fullNameField.classList.add('is-invalid');
            isValid = false;
        } else {
            fullNameField.classList.remove('is-invalid');
        }

        if (!emailField.value.trim() || !emailField.value.includes('@')) {
            emailField.classList.add('is-invalid');
            isValid = false;
        } else {
            emailField.classList.remove('is-invalid');
        }

        if (!passwordField.value.trim() || passwordField.value.length < 6) {
            passwordField.classList.add('is-invalid');
            isValid = false;
        } else {
            passwordField.classList.remove('is-invalid');
        }

        // Check if passwords match
        if (passwordField.value !== confirmPasswordField.value) {
            confirmPasswordField.classList.add('is-invalid');
            document.getElementById('passwordMismatch').style.display = 'block';
            isValid = false;
        } else {
            confirmPasswordField.classList.remove('is-invalid');
            document.getElementById('passwordMismatch').style.display = 'none';
        }

        if (!isValid) {
            e.preventDefault();
            showToast('Please fill in all required fields correctly', 'danger');
        } else {
            // This would be replaced with actual AJAX form submission
            e.preventDefault();
            
            // Simulate user addition and hide modal
            showToast('User added successfully!', 'success');
            simulateAddUser(
                fullNameField.value, 
                emailField.value, 
                departmentField.options[departmentField.selectedIndex].text,
                roleField.options[roleField.selectedIndex].text
            );
            
            // Hide modal and reset form
            bootstrap.Modal.getInstance(document.getElementById('addUserModal')).hide();
            this.reset();
        }
    });

    // Reset Password Handler
    document.querySelectorAll('.reset-password').forEach(function(button) {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            var userId = this.getAttribute('data-user-id');
            
            if (confirm('Are you sure you want to reset the password for this user?')) {
                // Simulate password reset
                showToast('Password has been reset and sent to user', 'success');
            }
        });
    });

    // Toggle User Status Handler
    document.querySelectorAll('.toggle-status').forEach(function(button) {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            var userId = this.getAttribute('data-user-id');
            var currentStatus = this.getAttribute('data-current-status');
            var actionText = currentStatus === 'active' ? 'deactivate' : 'activate';
            
            if (confirm('Are you sure you want to ' + actionText + ' this user?')) {
                // Simulate status toggle
                var newStatus = currentStatus === 'active' ? 'inactive' : 'active';
                var userRow = document.querySelector(`tr[data-user-id="${userId}"]`);
                
                if (userRow) {
                    userRow.setAttribute('data-status', newStatus);
                    var statusBadge = userRow.querySelector('td:nth-child(6) span');
                    
                    if (statusBadge) {
                        if (newStatus === 'active') {
                            statusBadge.className = 'badge bg-success';
                            statusBadge.textContent = 'Active';
                            this.innerHTML = '<i class="fas fa-user-times me-1 text-warning"></i> Deactivate User';
                            this.setAttribute('data-current-status', 'active');
                        } else {
                            statusBadge.className = 'badge bg-warning text-dark';
                            statusBadge.textContent = 'Inactive';
                            this.innerHTML = '<i class="fas fa-user-check me-1 text-success"></i> Activate User';
                            this.setAttribute('data-current-status', 'inactive');
                        }
                    }
                    
                    showToast(`User has been ${actionText}d`, 'success');
                }
            }
        });
    });

    // Delete User Handler (for individual delete buttons)
    document.querySelectorAll('.delete-user').forEach(function(button) {
        button.addEventListener('click', function() {
            var userId = this.getAttribute('data-user-id');
            var userName = this.getAttribute('data-user-name');
            
            document.getElementById('deleteUserName').textContent = userName;
            document.getElementById('deleteUserId').value = userId;
            document.getElementById('deleteUserForm').action = '/delete_user/' + userId;
        });
    });
    
    // Delete user form submission
    document.getElementById('deleteUserForm').addEventListener('submit', function(e) {
        e.preventDefault();
        var confirmDelete = document.getElementById('confirmDelete');
        
        if (!confirmDelete.checked) {
            confirmDelete.classList.add('is-invalid');
            return;
        }
        
        // Get user ID and remove the row
        var userId = document.getElementById('deleteUserId').value;
        var userRow = document.querySelector(`tr[data-user-id="${userId}"]`);
        
        if (userRow) {
            userRow.remove();
        }
        
        // Hide modal
        bootstrap.Modal.getInstance(document.getElementById('deleteUserModal')).hide();
        showToast('User has been deleted', 'success');
        
        // Update user count in stats
        updateUserCountStats();
    });

    // Edit User Handler
    document.querySelectorAll('.edit-user').forEach(function(button) {
        button.addEventListener('click', function() {
            var userId = this.getAttribute('data-user-id');
            // In a real application, you would fetch user data via AJAX
            // For this demo, we'll simulate with static data
            var userRow = document.querySelector(`tr[data-user-id="${userId}"]`);
            
            if (userRow) {
                var userName = userRow.querySelector('td:nth-child(2) a').textContent.trim();
                var userEmail = userRow.querySelector('td:nth-child(3)').textContent.trim();
                var userDepartment = userRow.querySelector('td:nth-child(4)').textContent.trim();
                var userRole = userRow.querySelector('td:nth-child(5) span').textContent.trim();
                var userStatus = userRow.querySelector('td:nth-child(6) span').textContent.trim() === 'Active';
                
                // Populate edit form
                document.getElementById('editUserId').value = userId;
                document.getElementById('editUserForm').action = '/edit-user/' + userId;
                document.getElementById('editUserFullName').value = userName;
                document.getElementById('editUserEmail').value = userEmail;
                
                // Set department dropdown
                var departmentSelect = document.getElementById('editUserDepartment');
                for (var i = 0; i < departmentSelect.options.length; i++) {
                    if (departmentSelect.options[i].text === userDepartment) {
                        departmentSelect.selectedIndex = i;
                        break;
                    }
                }
                
                // Set role dropdown
                var roleSelect = document.getElementById('editUserRole');
                for (var i = 0; i < roleSelect.options.length; i++) {
                    if (roleSelect.options[i].text === userRole) {
                        roleSelect.selectedIndex = i;
                        break;
                    }
                }
                
                // Set status
                document.getElementById('editUserStatus').checked = userStatus;
            }
        });
    });
    
    // Edit user form submission
    document.getElementById('editUserForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        var userId = document.getElementById('editUserId').value;
        var fullName = document.getElementById('editUserFullName').value;
        var email = document.getElementById('editUserEmail').value;
        var department = document.getElementById('editUserDepartment').options[document.getElementById('editUserDepartment').selectedIndex].text;
        var role = document.getElementById('editUserRole').options[document.getElementById('editUserRole').selectedIndex].text;
        var isActive = document.getElementById('editUserStatus').checked;
        
        // Update user in the table
        var userRow = document.querySelector(`tr[data-user-id="${userId}"]`);
        if (userRow) {
            userRow.querySelector('td:nth-child(2) a').textContent = fullName;
            userRow.querySelector('td:nth-child(3)').textContent = email;
            userRow.querySelector('td:nth-child(4)').textContent = department;
            
            var roleBadge = userRow.querySelector('td:nth-child(5) span');
            roleBadge.textContent = role;
            // Update role badge style based on role
            roleBadge.className = 'badge ';
            if (role === 'Administrator') {
                roleBadge.className += 'bg-danger';
            } else if (role === 'Manager') {
                roleBadge.className += 'bg-warning text-dark';
            } else if (role === 'Lead Scientist') {
                roleBadge.className += 'bg-info text-dark';
            } else {
                roleBadge.className += 'bg-secondary';
            }
            
            var statusBadge = userRow.querySelector('td:nth-child(6) span');
            if (isActive) {
                statusBadge.className = 'badge bg-success';
                statusBadge.textContent = 'Active';
            } else {
                statusBadge.className = 'badge bg-warning text-dark';
                statusBadge.textContent = 'Inactive';
            }
            
            // Update user status and toggle action text
            userRow.setAttribute('data-status', isActive ? 'active' : 'inactive');
            var toggleStatusBtn = userRow.querySelector('.toggle-status');
            if (toggleStatusBtn) {
                if (isActive) {
                    toggleStatusBtn.innerHTML = '<i class="fas fa-user-times me-1 text-warning"></i> Deactivate User';
                    toggleStatusBtn.setAttribute('data-current-status', 'active');
                } else {
                    toggleStatusBtn.innerHTML = '<i class="fas fa-user-check me-1 text-success"></i> Activate User';
                    toggleStatusBtn.setAttribute('data-current-status', 'inactive');
                }
            }
            
            // Update user count stats
            updateUserCountStats();
        }
        
        // Hide modal
        bootstrap.Modal.getInstance(document.getElementById('editUserModal')).hide();
        showToast('User updated successfully', 'success');
    });

    // User Search Functionality
    document.getElementById('userSearch').addEventListener('input', function() {
        var searchTerm = this.value.toLowerCase();
        var userRows = document.querySelectorAll('#usersTable tbody tr');
        
        userRows.forEach(function(row) {
            var name = row.querySelector('td:nth-child(2)').textContent.toLowerCase();
            var email = row.querySelector('td:nth-child(3)').textContent.toLowerCase();
            var department = row.querySelector('td:nth-child(4)').textContent.toLowerCase();
            
            if (name.includes(searchTerm) || email.includes(searchTerm) || department.includes(searchTerm)) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    });
    
    // Status Filter Functionality
    document.querySelectorAll('.user-filter').forEach(function(button) {
        button.addEventListener('click', function() {
            var status = this.getAttribute('data-filter');
            var userRows = document.querySelectorAll('#usersTable tbody tr');
            
            // Remove active class from all filters
            document.querySelectorAll('.user-filter').forEach(function(btn) {
                btn.classList.remove('active');
            });
            
            // Add active class to clicked button
            this.classList.add('active');
            
            userRows.forEach(function(row) {
                if (status === 'all' || row.getAttribute('data-status') === status) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });
    });
    
    // Select All Users Checkbox
    document.getElementById('selectAllUsers').addEventListener('change', function() {
        var isChecked = this.checked;
        document.querySelectorAll('.user-checkbox').forEach(function(checkbox) {
            checkbox.checked = isChecked;
        });
    });
    
    // Bulk Action Handler
    document.querySelectorAll('.bulk-action').forEach(function(link) {
        link.addEventListener('click', function(e) {
            var action = this.getAttribute('data-action');
            var selectedUsers = Array.from(document.querySelectorAll('.user-checkbox:checked')).map(function(checkbox) {
                return checkbox.value;
            });
            
            if (selectedUsers.length === 0) {
                alert('Please select at least one user');
                e.preventDefault();
                return;
            }
            
            // Handle different bulk actions
            switch(action) {
                case 'activate':
                    if (confirm('Are you sure you want to activate ' + selectedUsers.length + ' users?')) {
                        // Simulate activation
                        selectedUsers.forEach(function(userId) {
                            var userRow = document.querySelector(`tr[data-user-id="${userId}"]`);
                            if (userRow) {
                                userRow.setAttribute('data-status', 'active');
                                var statusBadge = userRow.querySelector('td:nth-child(6) span');
                                statusBadge.className = 'badge bg-success';
                                statusBadge.textContent = 'Active';
                                
                                // Update toggle button
                                var toggleBtn = userRow.querySelector('.toggle-status');
                                if (toggleBtn) {
                                    toggleBtn.innerHTML = '<i class="fas fa-user-times me-1 text-warning"></i> Deactivate User';
                                    toggleBtn.setAttribute('data-current-status', 'active');
                                }
                            }
                        });
                        updateUserCountStats();
                        showToast(selectedUsers.length + ' users activated successfully', 'success');
                    }
                    e.preventDefault();
                    break;
                    
                case 'deactivate':
                    if (confirm('Are you sure you want to deactivate ' + selectedUsers.length + ' users?')) {
                        // Simulate deactivation
                        selectedUsers.forEach(function(userId) {
                            var userRow = document.querySelector(`tr[data-user-id="${userId}"]`);
                            if (userRow) {
                                userRow.setAttribute('data-status', 'inactive');
                                var statusBadge = userRow.querySelector('td:nth-child(6) span');
                                statusBadge.className = 'badge bg-warning text-dark';
                                statusBadge.textContent = 'Inactive';
                                
                                // Update toggle button
                                var toggleBtn = userRow.querySelector('.toggle-status');
                                if (toggleBtn) {
                                    toggleBtn.innerHTML = '<i class="fas fa-user-check me-1 text-success"></i> Activate User';
                                    toggleBtn.setAttribute('data-current-status', 'inactive');
                                }
                            }
                        });
                        updateUserCountStats();
                        showToast(selectedUsers.length + ' users deactivated successfully', 'success');
                    }
                    e.preventDefault();
                    break;
                    
                case 'delete':
                    if (confirm('Are you sure you want to delete ' + selectedUsers.length + ' users? This action cannot be undone.')) {
                        // Simulate deletion
                        selectedUsers.forEach(function(userId) {
                            var userRow = document.querySelector(`tr[data-user-id="${userId}"]`);
                            if (userRow) {
                                userRow.remove();
                            }
                        });
                        updateUserCountStats();
                        showToast(selectedUsers.length + ' users deleted successfully', 'success');
                    }
                    e.preventDefault();
                    break;
                    
                case 'export':
                    // Simulate export - create CSV
                    var csvContent = "data:text/csv;charset=utf-8,";
                    csvContent += "ID,Name,Email,Department,Role,Status,Last Login\n";
                    
                    selectedUsers.forEach(function(userId) {
                        var userRow = document.querySelector(`tr[data-user-id="${userId}"]`);
                        if (userRow) {
                            var name = userRow.querySelector('td:nth-child(2) a').textContent.trim();
                            var email = userRow.querySelector('td:nth-child(3)').textContent.trim();
                            var department = userRow.querySelector('td:nth-child(4)').textContent.trim();
                            var role = userRow.querySelector('td:nth-child(5) span').textContent.trim();
                            var status = userRow.querySelector('td:nth-child(6) span').textContent.trim();
                            var lastLogin = userRow.querySelector('td:nth-child(7)').textContent.trim();
                            
                            csvContent += `${userId},"${name}","${email}","${department}","${role}","${status}","${lastLogin}"\n`;
                        }
                    });
                    
                    var encodedUri = encodeURI(csvContent);
                    var link = document.createElement("a");
                    link.setAttribute("href", encodedUri);
                    link.setAttribute("download", "selected_users.csv");
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    showToast(selectedUsers.length + ' users exported successfully', 'success');
                    e.preventDefault();
                    break;
                    
                case 'assign-role':
                    // Populate hidden input with selected user IDs
                    document.getElementById('roleUserIds').value = selectedUsers.join(',');
                    // Modal will be shown by Bootstrap
                    break;
                    
                case 'assign-department':
                    // Populate hidden input with selected user IDs
                    document.getElementById('departmentUserIds').value = selectedUsers.join(',');
                    // Modal will be shown by Bootstrap
                    break;
                    
                case 'send-notification':
                    // Populate hidden input with selected user IDs
                    document.getElementById('notificationUserIds').value = selectedUsers.join(',');
                    document.getElementById('notificationModalTitle').textContent = 'Send Notification to Multiple Users';
                    // Modal will be shown by Bootstrap
                    break;
            }
        });
    });
    
    // Handle role assignment form
    document.getElementById('assignRoleForm').addEventListener('submit', function(e) {
        e.preventDefault();
        var userIds = document.getElementById('roleUserIds').value.split(',');
        var roleSelect = document.getElementById('assignRole');
        var role = roleSelect.options[roleSelect.selectedIndex].text;
        
        // Update role for each selected user
        userIds.forEach(function(userId) {
            var userRow = document.querySelector(`tr[data-user-id="${userId}"]`);
            if (userRow) {
                var roleBadge = userRow.querySelector('td:nth-child(5) span');
                roleBadge.textContent = role;
                
                // Update role badge style based on role
                roleBadge.className = 'badge ';
                if (role === 'Administrator') {
                    roleBadge.className += 'bg-danger';
                } else if (role === 'Manager') {
                    roleBadge.className += 'bg-warning text-dark';
                } else if (role === 'Lead Scientist') {
                    roleBadge.className += 'bg-info text-dark';
                } else {
                    roleBadge.className += 'bg-secondary';
                }
            }
        });
        
        // Hide modal
        bootstrap.Modal.getInstance(document.getElementById('assignRoleModal')).hide();
        showToast(`Role assigned to ${userIds.length} users successfully`, 'success');
        
        // Update user stats
        updateUserCountStats();
    });
    
    // Handle department assignment form
    document.getElementById('assignDepartmentForm').addEventListener('submit', function(e) {
        e.preventDefault();
        var userIds = document.getElementById('departmentUserIds').value.split(',');
        var departmentSelect = document.getElementById('assignDepartment');
        var department = departmentSelect.options[departmentSelect.selectedIndex].text;
        
        // Update department for each selected user
        userIds.forEach(function(userId) {
            var userRow = document.querySelector(`tr[data-user-id="${userId}"]`);
            if (userRow) {
                userRow.querySelector('td:nth-child(4)').textContent = department;
            }
        });
        
        // Hide modal
        bootstrap.Modal.getInstance(document.getElementById('assignDepartmentModal')).hide();
        showToast(`Department assigned to ${userIds.length} users successfully`, 'success');
    });
    
    // Handle notification form submission
    document.getElementById('sendNotificationForm').addEventListener('submit', function(e) {
        e.preventDefault();
        var userIds = document.getElementById('notificationUserIds').value.split(',');
        var message = document.getElementById('notificationMessage').value;
        var notificationType = document.getElementById('notificationType').value;
        
        // Hide modal
        bootstrap.Modal.getInstance(document.getElementById('sendNotificationModal')).hide();
        
        // Show notification sent confirmation
        showToast(`Notification sent to ${userIds.length} user(s) successfully`, 'success');
    });
    
    // Template Download
    document.getElementById('downloadTemplate').addEventListener('click', function() {
        // Create CSV content
        var csvContent = 'Full Name,Email,Phone,Department,Role,Password\n';
        csvContent += 'John Doe,john.doe@example.com,+254712345678,Lab Operations,Lab Technician,password123\n';
        csvContent += 'Jane Smith,jane.smith@example.com,+254723456789,Administration,Manager,password456\n';
        
        // Create blob and download link
        var blob = new Blob([csvContent], { type: 'text/csv' });
        var url = URL.createObjectURL(blob);
        var downloadLink = document.createElement('a');
        downloadLink.href = url;
        downloadLink.download = 'users_import_template.csv';
        
        document.body.appendChild(downloadLink);
        downloadLink.click();
        document.body.removeChild(downloadLink);
    });

    // Simulate adding a new user to the table
    function simulateAddUser(name, email, department, role = 'Staff') {
        // Generate random ID
        var userId = Math.floor(Math.random() * 10000);
        
        // Create table row HTML
        var html = `
            <tr class="user-row" data-user-id="${userId}" data-status="active">
                <td>
                    <div class="form-check">
                        <input class="form-check-input user-checkbox" type="checkbox" id="userCheck${userId}" value="${userId}" title="Select user ${name}">
                        <label class="form-check-label" for="userCheck${userId}"><span class="visually-hidden">Select {{ name }}</span></label>
                    </div>
                </td>
                <td>
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="avatar-container">
                                <img class="avatar-img" src="/static/images/user.png" alt="User Avatar" onerror="this.onerror=null; this.classList.add('error');">
                                <div class="avatar-circle">
                                    <span class="initials">${name.substring(0, 2).toUpperCase()}</span>
                                </div>
                            </div>
                        </div>
                        <div class="ms-3">
                            <a href="#">${name}</a>
                            <div class="small text-muted">No logins recorded</div>
                        </div>
                    </div>
                </td>
                <td>${email}</td>
                <td>${department}</td>
                <td>
                    <span class="badge ${role === 'Administrator' ? 'bg-danger' : 
                        role === 'Manager' ? 'bg-warning text-dark' : 
                        role === 'Lead Scientist' ? 'bg-info text-dark' : 
                        'bg-secondary'}">${role}</span>
                </td>
                <td>
                    <span class="badge bg-success">Active</span>
                </td>
                <td>Never</td>
                <td>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                            Actions
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="#"><i class="fas fa-user me-1 text-primary"></i> View Profile</a></li>
                            <li><a class="dropdown-item edit-user" href="#" data-bs-toggle="modal" data-bs-target="#editUserModal" data-user-id="${userId}" data-user-name="${name}"><i class="fas fa-edit me-1 text-info"></i> Edit User</a></li>
                            <li><a class="dropdown-item reset-password" href="#" data-user-id="${userId}"><i class="fas fa-key me-1 text-warning"></i> Reset Password</a></li>
                            <li><a class="dropdown-item send-notification" href="#" data-bs-toggle="modal" data-bs-target="#sendNotificationModal" data-user-id="${userId}" data-user-name="${name}"><i class="fas fa-bell me-1 text-primary"></i> Send Notification</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <a class="dropdown-item toggle-status" href="#" data-user-id="${userId}" data-current-status="active">
                                    <i class="fas fa-user-times me-1 text-warning"></i> Deactivate User
                                </a>
                            </li>
                            <li><a class="dropdown-item delete-user" href="#" data-bs-toggle="modal" data-bs-target="#deleteUserModal" data-user-id="${userId}" data-user-name="${name}"><i class="fas fa-trash me-1 text-danger"></i> Delete User</a></li>
                        </ul>
                    </div>
                </td>
            </tr>
        `;
        
        // Add to table
        var tbody = document.querySelector('#usersTable tbody');
        tbody.insertAdjacentHTML('afterbegin', html);
        
        // Re-attach event listeners to new elements
        attachEventListenersToNewRow(userId);
        
        // Update user count stats
        updateUserCountStats();
    }

    // Function to attach event listeners to newly added row
    function attachEventListenersToNewRow(userId) {
        // Attach edit user event listener
        var editBtn = document.querySelector(`tr[data-user-id="${userId}"] .edit-user`);
        if (editBtn) {
            editBtn.addEventListener('click', function() {
                var userId = this.getAttribute('data-user-id');
                var userRow = document.querySelector(`tr[data-user-id="${userId}"]`);
                
                if (userRow) {
                    var userName = userRow.querySelector('td:nth-child(2) a').textContent.trim();
                    var userEmail = userRow.querySelector('td:nth-child(3)').textContent.trim();
                    var userDepartment = userRow.querySelector('td:nth-child(4)').textContent.trim();
                    var userRole = userRow.querySelector('td:nth-child(5) span').textContent.trim();
                    var userStatus = userRow.querySelector('td:nth-child(6) span').textContent.trim() === 'Active';
                    
                    document.getElementById('editUserId').value = userId;
                    document.getElementById('editUserForm').action = '/edit-user/' + userId;
                    document.getElementById('editUserFullName').value = userName;
                    document.getElementById('editUserEmail').value = userEmail;
                    
                    // Set department dropdown
                    var departmentSelect = document.getElementById('editUserDepartment');
                    for (var i = 0; i < departmentSelect.options.length; i++) {
                        if (departmentSelect.options[i].text === userDepartment) {
                            departmentSelect.selectedIndex = i;
                            break;
                        }
                    }
                    
                    // Set role dropdown
                    var roleSelect = document.getElementById('editUserRole');
                    for (var i = 0; i < roleSelect.options.length; i++) {
                        if (roleSelect.options[i].text === userRole) {
                            roleSelect.selectedIndex = i;
                            break;
                        }
                    }
                    
                    // Set status
                    document.getElementById('editUserStatus').checked = userStatus;
                }
            });
        }
        
        // Attach delete user event listener
        var deleteBtn = document.querySelector(`tr[data-user-id="${userId}"] .delete-user`);
        if (deleteBtn) {
            deleteBtn.addEventListener('click', function() {
                var userId = this.getAttribute('data-user-id');
                var userName = this.getAttribute('data-user-name');
                
                document.getElementById('deleteUserName').textContent = userName;
                document.getElementById('deleteUserId').value = userId;
                document.getElementById('deleteUserForm').action = '/delete_user/' + userId;
            });
        }
        
        // Attach toggle status event listener
        var toggleBtn = document.querySelector(`tr[data-user-id="${userId}"] .toggle-status`);
        if (toggleBtn) {
            toggleBtn.addEventListener('click', function(e) {
                e.preventDefault();
                var userId = this.getAttribute('data-user-id');
                var currentStatus = this.getAttribute('data-current-status');
                var actionText = currentStatus === 'active' ? 'deactivate' : 'activate';
                
                if (confirm('Are you sure you want to ' + actionText + ' this user?')) {
                    var newStatus = currentStatus === 'active' ? 'inactive' : 'active';
                    var userRow = document.querySelector(`tr[data-user-id="${userId}"]`);
                    
                    if (userRow) {
                        userRow.setAttribute('data-status', newStatus);
                        var statusBadge = userRow.querySelector('td:nth-child(6) span');
                        
                        if (statusBadge) {
                            if (newStatus === 'active') {
                                statusBadge.className = 'badge bg-success';
                                statusBadge.textContent = 'Active';
                                this.innerHTML = '<i class="fas fa-user-times me-1 text-warning"></i> Deactivate User';
                                this.setAttribute('data-current-status', 'active');
                            } else {
                                statusBadge.className = 'badge bg-warning text-dark';
                                statusBadge.textContent = 'Inactive';
                                this.innerHTML = '<i class="fas fa-user-check me-1 text-success"></i> Activate User';
                                this.setAttribute('data-current-status', 'inactive');
                            }
                        }
                        
                        showToast(`User has been ${actionText}d`, 'success');
                        updateUserCountStats();
                    }
                }
            });
        }
        
        // Attach reset password event listener
        var resetBtn = document.querySelector(`tr[data-user-id="${userId}"] .reset-password`);
        if (resetBtn) {
            resetBtn.addEventListener('click', function(e) {
                e.preventDefault();
                var userId = this.getAttribute('data-user-id');
                
                if (confirm('Are you sure you want to reset the password for this user?')) {
                    showToast('Password has been reset and sent to user', 'success');
                }
            });
        }
        
        // Attach send notification event listener
        var notifyBtn = document.querySelector(`tr[data-user-id="${userId}"] .send-notification`);
        if (notifyBtn) {
            notifyBtn.addEventListener('click', function() {
                var userId = this.getAttribute('data-user-id');
                var userName = this.getAttribute('data-user-name');
                
                document.getElementById('notificationUserIds').value = userId;
                document.getElementById('notificationModalTitle').textContent = 'Send Notification to ' + userName;
                document.getElementById('sendNotificationForm').action = '/send_notification/' + userId;
            });
        }
    }
    
    // Function to update user count statistics
    function updateUserCountStats() {
        var totalUsers = document.querySelectorAll('#usersTable tbody tr').length;
        var activeUsers = document.querySelectorAll('#usersTable tbody tr[data-status="active"]').length;
        var inactiveUsers = document.querySelectorAll('#usersTable tbody tr[data-status="inactive"]').length;
        var adminUsers = document.querySelectorAll('#usersTable tbody tr td:nth-child(5) span.badge.bg-danger').length;
        
        // Update stats in cards
        document.querySelector('.card:nth-of-type(1) .h5').textContent = totalUsers;
        document.querySelector('.card:nth-of-type(2) .h5').textContent = activeUsers;
        document.querySelector('.card:nth-of-type(3) .h5').textContent = inactiveUsers;
        document.querySelector('.card:nth-of-type(4) .h5').textContent = adminUsers;
    }
    
    // Function to show notifications
    function showToast(message, type) {
        var toastContainer = document.querySelector('.toast-container');
        
        // Create toast container if it doesn't exist
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3';
            document.body.appendChild(toastContainer);
        }
        
        // Create toast element
        var toast = document.createElement('div');
        toast.className = `toast align-items-center text-white bg-${type} border-0`;
        toast.setAttribute('role', 'alert');
        toast.setAttribute('aria-live', 'assertive');
        toast.setAttribute('aria-atomic', 'true');
        
        // Toast content
        toast.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        `;
        
        // Add toast to container
        toastContainer.appendChild(toast);
        
        // Initialize and show the toast
        var bsToast = new bootstrap.Toast(toast, {
            autohide: true,
            delay: 3000
        });
        bsToast.show();
        
        // Remove toast after it's hidden
        toast.addEventListener('hidden.bs.toast', function() {
            this.remove();
        });
    }
    
    // Initialize tooltips for newly added elements
    function initTooltips() {
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.forEach(function(tooltipTriggerEl) {
            new bootstrap.Tooltip(tooltipTriggerEl);
        });
    }
    
    // Function to create avatar with initials when images are missing
    document.querySelectorAll('img.avatar-img').forEach(function(img) {
        // Add error handler to each avatar image
        img.addEventListener('error', function() {
            // Hide broken image
            this.style.display = 'none';
            // Add error class
            this.classList.add('error');
            // Show avatar circle with initials
            if (this.nextElementSibling && this.nextElementSibling.classList.contains('avatar-circle')) {
                this.nextElementSibling.style.display = 'flex';
            }
        });
        
        // Check if image is already loaded but broken
        if (img.complete) {
            if (img.naturalHeight === 0 || img.naturalWidth === 0) {
                img.dispatchEvent(new Event('error'));
            }
        }
    });
});
</script>

<style>
.avatar-circle {
    width: 40px;
    height: 40px;
    background-color: #007bff;
    text-align: center;
    border-radius: 50%;
    -webkit-border-radius: 50%;
    -moz-border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
}

.initials {
    font-size: 15px;
    line-height: 1;
    color: #fff;
    font-weight: bold;
}

.border-left-primary {
    border-left: 0.25rem solid #007bff !important;
}

.border-left-success {
    border-left: 0.25rem solid #28a745 !important;
}

.border-left-warning {
    border-left: 0.25rem solid #ffc107 !important;
}

.border-left-danger {
    border-left: 0.25rem solid #dc3545 !important;
}

/* Add fallback for missing image */
img.avatar-img {
    max-width: 40px;
    height: auto;
    border-radius: 50%;
}

.avatar-container {
    position: relative;
    width: 40px;
    height: 40px;
}

/* Hide the default avatar circle initially */
.avatar-circle {
    display: none;
    position: absolute;
    top: 0;
    left: 0;
}

/* Show the avatar circle when the image fails to load */
img.avatar-img.error + .avatar-circle {
    display: flex !important;
}

/* Enhanced table styling */
.table-bordered td, .table-bordered th {
    border: 1px solid #e3e6f0;
}

.table-hover tbody tr:hover {
    background-color: rgba(0,123,255,0.05);
}

/* Add animation effects */
.card {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.card:hover {
    transform: translateY(-5px);
    box-shadow: 0 .5rem 1rem rgba(0,0,0,.15);
}

/* Add hover effects to action buttons */
.btn-outline-secondary:hover {
    background-color: #6c757d;
    color: white;
}

.btn-primary:hover {
    background-color: #0069d9;
}

/* Toast styling */
.toast {
    opacity: 1 !important;
    box-shadow: 0 .5rem 1rem rgba(0,0,0,.15);
}

/* Animate new users */
@keyframes highlight {
    0% { background-color: rgba(0,123,255,0.2); }
    100% { background-color: transparent; }
}

tr.user-row:first-child {
    animation: highlight 2s ease;
}

/* Style user search field */
#userSearch {
    border-radius: 0.25rem;
    border: 1px solid #ced4da;
    transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
}

#userSearch:focus {
    border-color: #80bdff;
    box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
}

/* Enhanced filter buttons */
.user-filter {
    position: relative;
    overflow: hidden;
}

.user-filter::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 0;
    height: 0;
    background-color: rgba(0,0,0,0.1);
    border-radius: 50%;
    transform: translate(-50%, -50%);
    transition: width 0.3s, height 0.3s;
}

.user-filter:active::after {
    width: 100%;
    height: 100%;
    border-radius: 0;
}

/* Improve accessibility */
.form-check-input:focus {
    box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
}

.btn:focus {
    box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
}

/* View user profile page enhancements */
#viewUserModal .avatar-container {
    width: 100px;
    height: 100px;
    margin: 0 auto;
}

#viewUserModal .avatar-img {
    max-width: 100px;
    max-height: 100px;
}

#viewUserModal .avatar-circle {
    width: 100px;
    height: 100px;
}

#viewUserModal .avatar-circle .initials {
    font-size: 32px;
}
</style>
{% endblock %} 
{% extends 'base.html' %}

{% block title %}User Management - KEMRI Document Management System{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <h2 class="mb-4">User Management</h2>

<!-- Flash messages -->
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    {% endfor %}
  {% endif %}
{% endwith %}

    <div class="card mb-4">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">All Users</h5>
            <div class="d-flex gap-2">
                <!-- Bulk Actions Dropdown -->
        <div class="dropdown">
                    <button type="button" class="btn btn-outline-primary" id="bulkActionsBtn" disabled data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-tasks me-1"></i> Bulk Actions
            </button>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="bulkActionsBtn">
                        <form id="bulkActionForm" action="{{ url_for('bulk_user_action') }}" method="post" aria-label="Bulk actions form">
                            <input type="hidden" name="user_ids" id="bulkUserIds" value="" title="Selected user IDs">
                            <input type="hidden" name="action" id="bulkActionType" value="" title="Bulk action type">
                            
                            <li><button type="button" class="dropdown-item bulk-action-btn" data-action="activate">
                                <i class="fas fa-user-check me-2"></i> Activate Users
                            </button></li>
                            <li><button type="button" class="dropdown-item bulk-action-btn" data-action="deactivate">
                                <i class="fas fa-user-slash me-2"></i> Deactivate Users
                            </button></li>
                <li><hr class="dropdown-divider"></li>
                            <li><button type="button" class="dropdown-item bulk-action-btn" data-action="delete" data-bs-toggle="modal" data-bs-target="#confirmDeleteModal">
                                <i class="fas fa-trash me-2 text-danger"></i> Delete Users
                            </button></li>
                <li><hr class="dropdown-divider"></li>
                            <li><button type="button" class="dropdown-item bulk-action-btn" data-action="assign_role" data-bs-toggle="modal" data-bs-target="#assignRoleModal">
                                <i class="fas fa-user-tag me-2"></i> Assign Role
                            </button></li>
                            <li><button type="button" class="dropdown-item bulk-action-btn" data-action="assign_department" data-bs-toggle="modal" data-bs-target="#assignDepartmentModal">
                                <i class="fas fa-building me-2"></i> Assign Department
                            </button></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><button type="button" class="dropdown-item bulk-action-btn" data-action="reset-password" data-bs-toggle="modal" data-bs-target="#resetPasswordModal">
                                <i class="fas fa-key me-2"></i> Reset Password
                            </button></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><button type="button" class="dropdown-item bulk-action-btn" data-action="export" data-bs-toggle="modal" data-bs-target="#exportUsersModal">
                                <i class="fas fa-file-export me-2"></i> Export Users
                            </button></li>
                            <li><button type="button" class="dropdown-item bulk-action-btn" data-action="send_credentials" data-bs-toggle="modal" data-bs-target="#sendCredentialsModal">
                                <i class="fas fa-envelope me-2"></i> Email Credentials
                            </button></li>
                        </form>
            </ul>
        </div>
                
                <!-- Add User Button -->
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addUserModal">
                    <i class="fas fa-user-plus me-1"></i> Add New User
                </button>
    </div>
        </div>
        <div class="card-body p-0">
        <div class="table-responsive">
                <table class="table table-hover align-middle mb-0" id="usersTable">
                    <thead class="table-light">
                    <tr>
                            <th width="40">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="selectAllUsers" title="Select all users" aria-label="Select all users">
                                    <label class="visually-hidden" for="selectAllUsers">Select all users</label>
                            </div>
                        </th>
                        <th>Name</th>
                        <th>Email</th>
                            <th>Phone</th>
                        <th>Department</th>
                        <th>Role</th>
                        <th>Status</th>
                        <th>Last Login</th>
                            <th>Created</th>
                            <th width="120">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in users %}
                        <tr>
                        <td>
                            <div class="form-check">
                                    <input class="form-check-input user-checkbox" type="checkbox" value="{{ user.id }}" data-username="{{ user.username }}" title="Select user {{ user.username }}" aria-label="Select {{ user.username }}">
                            </div>
                        </td>
                            <td>{{ user.username }}</td>
                        <td>{{ user.email }}</td>
                            <td>{{ user.phone }}</td>
                        <td>{{ user.department }}</td>
                        <td>
                                <span class="badge bg-{{ 'primary' if user.role == 'Administrator' else 'secondary' }}">
                                    {{ user.role }}
                                </span>
                        </td>
                        <td>
                                <span class="badge bg-{{ 'success' if user.is_active else 'danger' }}">
                                    {{ 'Active' if user.is_active else 'Inactive' }}
                                </span>
                        </td>
                            <td>{{ user.last_login.strftime('%Y-%m-%d %H:%M') if user.last_login else 'Never' }}</td>
                            <td>{{ user.created_at.strftime('%Y-%m-%d') if user.created_at else 'Unknown' }}</td>
                            <td>
                                <div class="btn-group">
                                    <button type="button" class="btn btn-sm btn-outline-secondary edit-user-btn" 
                                            data-bs-toggle="modal" data-bs-target="#editUserModal"
                                            data-user-id="{{ user.id }}"
                                            data-username="{{ user.username }}"
                                            data-email="{{ user.email }}"
                                            data-phone="{{ user.phone }}"
                                            data-department="{{ user.department }}"
                                            data-role="{{ user.role }}"
                                            title="Edit {{ user.username }}"
                                            aria-label="Edit {{ user.username }}">
                                        <i class="fas fa-edit"></i>
                                </button>
                                    <a href="{{ url_for('my_account') }}?user_id={{ user.id }}" class="btn btn-sm btn-outline-info" title="View user details" aria-label="View user details">
                                        <i class="fas fa-user"></i>
                                    </a>
                                    <button type="button" class="btn btn-sm btn-outline-warning reset-pwd-btn"
                                            data-bs-toggle="modal" data-bs-target="#singleResetPasswordModal"
                                            data-user-id="{{ user.id }}"
                                            data-username="{{ user.username }}"
                                            title="Reset password for {{ user.username }}"
                                            aria-label="Reset password for {{ user.username }}">
                                        <i class="fas fa-key"></i>
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-{{ 'success' if not user.is_active else 'danger' }} toggle-status-btn"
                                            data-bs-toggle="modal" 
                                            data-bs-target="#toggleStatusModal"
                                            data-user-id="{{ user.id }}"
                                            data-username="{{ user.username }}"
                                            data-status="{{ 'inactive' if user.is_active else 'active' }}"
                                            title="{{ 'Activate' if not user.is_active else 'Deactivate' }} {{ user.username }}"
                                            aria-label="{{ 'Activate' if not user.is_active else 'Deactivate' }} {{ user.username }}">
                                        <i class="fas fa-{{ 'user-check' if not user.is_active else 'user-slash' }}"></i>
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-danger delete-user-btn"
                                            data-bs-toggle="modal" data-bs-target="#deleteUserModal"
                                            data-user-id="{{ user.id }}"
                                            data-username="{{ user.username }}"
                                            title="Delete {{ user.username }}"
                                            aria-label="Delete {{ user.username }}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        </div>
    </div>
</div>

<!-- Add User Modal -->
<div class="modal fade" id="addUserModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ url_for('add_user') }}" method="post">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="username" class="form-label">Username</label>
                        <input type="text" class="form-control" id="username" name="username" required>
                    </div>
                    <div class="mb-3">
                        <label for="email" class="form-label">Email</label>
                        <input type="email" class="form-control" id="email" name="email" required>
                    </div>
                    <div class="mb-3">
                        <label for="department" class="form-label">Department</label>
                        <select class="form-select" id="department" name="department" required>
                            <option value="" selected disabled>Select Department</option>
                            {% for dept in departments %}
                            <option value="{{ dept }}">{{ dept }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="role" class="form-label">Role</label>
                        <select class="form-select" id="role" name="role" required>
                            <option value="" selected disabled>Select Role</option>
                            {% for role in roles %}
                            <option value="{{ role }}">{{ role }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="password" class="form-label">Password</label>
                        <input type="password" class="form-control" id="password" name="password" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add User</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit User Modal -->
<div class="modal fade" id="editUserModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editUserForm" method="post">
            <div class="modal-body">
                    <div class="mb-3">
                        <label for="editFullName" class="form-label">Full Name</label>
                        <input type="text" class="form-control" id="editFullName" name="fullName" required>
                        </div>
                    <div class="mb-3">
                        <label for="editEmail" class="form-label">Email</label>
                        <input type="email" class="form-control" id="editEmail" name="email" required>
                        </div>
                    <div class="mb-3">
                        <label for="editPhone" class="form-label">Phone</label>
                        <input type="text" class="form-control" id="editPhone" name="phone">
                    </div>
                    <div class="mb-3">
                        <label for="editDepartment" class="form-label">Department</label>
                        <select class="form-select" id="editDepartment" name="department" required>
                            <option value="" disabled>Select Department</option>
                            {% for dept in departments %}
                            <option value="{{ dept }}">{{ dept }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    <div class="mb-3">
                        <label for="editRole" class="form-label">Role</label>
                        <select class="form-select" id="editRole" name="role" required>
                            <option value="" disabled>Select Role</option>
                                {% for role in roles %}
                                <option value="{{ role }}">{{ role }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    <div class="mb-3">
                        <label for="editPassword" class="form-label">New Password (leave blank to keep current)</label>
                        <input type="password" class="form-control" id="editPassword" name="password">
                            </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
            </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete User Modal -->
<div class="modal fade" id="deleteUserModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete user <strong id="deleteUserName"></strong>?</p>
                <p class="text-danger">This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form id="deleteUserForm" method="post">
                    <button type="submit" class="btn btn-danger">Delete</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Confirm Delete Multiple Users Modal -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Delete Users</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete the selected users?</p>
                <p>The following users will be deleted:</p>
                <ul id="selectedUsersList" class="mb-0"></ul>
                <p class="text-danger mt-3">This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmBulkDeleteBtn">Delete Users</button>
            </div>
        </div>
    </div>
</div>

<!-- Assign Role Modal -->
<div class="modal fade" id="assignRoleModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Assign Role</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                    <div class="mb-3">
                    <label for="bulkRoleSelect" class="form-label">Select Role</label>
                    <select class="form-select" id="bulkRoleSelect" name="role">
                            {% for role in roles %}
                            <option value="{{ role }}">{{ role }}</option>
                            {% endfor %}
                        </select>
                    </div>
                <p>This role will be assigned to all selected users:</p>
                <ul id="roleUsersList" class="mb-0"></ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmRoleBtn">Assign Role</button>
            </div>
        </div>
    </div>
</div>

<!-- Assign Department Modal -->
<div class="modal fade" id="assignDepartmentModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Assign Department</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                    <div class="mb-3">
                    <label for="bulkDepartmentSelect" class="form-label">Select Department</label>
                    <select class="form-select" id="bulkDepartmentSelect" name="department">
                        {% for dept in departments %}
                        <option value="{{ dept }}">{{ dept }}</option>
                            {% endfor %}
                        </select>
                </div>
                <p>This department will be assigned to all selected users:</p>
                <ul id="departmentUsersList" class="mb-0"></ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmDepartmentBtn">Assign Department</button>
            </div>
        </div>
    </div>
                    </div>
                    
<!-- Reset Password Modal -->
<div class="modal fade" id="resetPasswordModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Reset User Passwords</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    This action will reset passwords for all selected users. New randomly generated passwords will be displayed after reset.
                </div>
                <p>Password will be reset for the following users:</p>
                <ul id="resetPasswordUsersList" class="mb-0"></ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" id="confirmResetPasswordBtn">Reset Passwords</button>
            </div>
        </div>
    </div>
</div>

<!-- Export Users Modal -->
<div class="modal fade" id="exportUsersModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Export Users</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                    <div class="mb-3">
                    <label for="exportFormat" class="form-label">Export Format</label>
                    <select class="form-select" id="exportFormat" name="format">
                        <option value="csv">CSV</option>
                        <option value="excel">Excel</option>
                        <option value="pdf">PDF</option>
                        </select>
                    </div>
                    <div class="mb-3">
                    <label class="form-label d-block">Include Fields</label>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" id="exportName" name="fields" value="name" checked>
                        <label class="form-check-label" for="exportName">Name</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" id="exportEmail" name="fields" value="email" checked>
                        <label class="form-check-label" for="exportEmail">Email</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" id="exportPhone" name="fields" value="phone" checked>
                        <label class="form-check-label" for="exportPhone">Phone</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" id="exportDept" name="fields" value="department" checked>
                        <label class="form-check-label" for="exportDept">Department</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" id="exportRole" name="fields" value="role" checked>
                        <label class="form-check-label" for="exportRole">Role</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" id="exportStatus" name="fields" value="status" checked>
                        <label class="form-check-label" for="exportStatus">Status</label>
                    </div>
                </div>
                <p>Users to export:</p>
                <ul id="exportUsersList" class="mb-0"></ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmExportBtn">Export</button>
            </div>
        </div>
    </div>
                    </div>
                    
<!-- Send Credentials Modal -->
<div class="modal fade" id="sendCredentialsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Send Credentials by Email</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    This action will send login credentials to all selected users.
                </div>
                <div class="mb-3">
                    <label for="emailSubject" class="form-label">Email Subject</label>
                    <input type="text" class="form-control" id="emailSubject" name="subject" value="Your KEMRI Document Management System Credentials">
                </div>
                <div class="mb-3">
                    <label for="emailMessage" class="form-label">Additional Message</label>
                    <textarea class="form-control" id="emailMessage" name="message" rows="3" placeholder="Optional message to include in the email"></textarea>
                </div>
                <p>Credentials will be sent to:</p>
                <ul id="credentialsUsersList" class="mb-0"></ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmSendCredentialsBtn">Send</button>
            </div>
        </div>
    </div>
</div>

<!-- Single Reset Password Modal -->
<div class="modal fade" id="singleResetPasswordModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Reset User Password</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="singleResetPasswordForm" method="post">
            <div class="modal-body">
                    <p>Are you sure you want to reset the password for <strong id="resetPasswordUsername"></strong>?</p>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="generatePassword" checked>
                            <label class="form-check-label" for="generatePassword">Generate random password</label>
                            </div>
                        </div>
                    <div class="mb-3" id="customPasswordField" style="display: none;">
                        <label for="newPassword" class="form-label">New Password</label>
                        <input type="password" class="form-control" id="newPassword" name="password">
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="emailPassword" name="email_password">
                        <label class="form-check-label" for="emailPassword">Email new password to user</label>
                        </div>
                        </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-warning">Reset Password</button>
                        </div>
            </form>
                        </div>
                        </div>
                        </div>

<!-- Toggle Status Modal -->
<div class="modal fade" id="toggleStatusModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="toggleStatusTitle">Change User Status</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
            <form id="toggleStatusForm" method="post">
                <div class="modal-body">
                    <p id="toggleStatusMessage">Are you sure you want to change the status for this user?</p>
                    <input type="hidden" id="toggleStatusAction" name="action" value="">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="confirmToggleStatusBtn">Confirm</button>
                        </div>
            </form>
                    </div>
    </div>
</div>

<!-- Import Users Modal -->
<div class="modal fade" id="importUsersModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Import Users</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ url_for('import_users') }}" method="post" enctype="multipart/form-data">
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Upload a CSV file to import multiple users at once. 
                        <a href="#" class="alert-link" id="downloadTemplateBtn">Download template</a>.
                    </div>
                    
                    <div class="mb-3">
                        <label for="importFile" class="form-label">Select File</label>
                        <input type="file" class="form-control" id="importFile" name="file" accept=".csv,.xlsx" required>
                    </div>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="overwriteExisting" name="overwrite">
                        <label class="form-check-label" for="overwriteExisting">
                            Overwrite existing users
                        </label>
                    </div>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="sendImportNotifications" name="send_email">
                        <label class="form-check-label" for="sendImportNotifications">
                            Send email notifications to imported users
                        </label>
                </div>
            </div>
            <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Import</button>
            </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
        // Select all checkbox
        const selectAllCheckbox = document.getElementById('selectAllUsers');
        const userCheckboxes = document.querySelectorAll('.user-checkbox');
        
        // Bulk action variables
        const bulkActionsBtn = document.getElementById('bulkActionsBtn');
        const bulkUserIdsInput = document.getElementById('bulkUserIds');
        
        // Initialize DataTable
        const userTable = new DataTable('#usersTable', {
            order: [[1, 'asc']],
            pageLength: 25,
            language: {
                search: "Search users:"
            },
            columnDefs: [
                { orderable: false, targets: [0, 8] } // Disable sorting on checkbox and actions columns
            ]
        });
        
        // Add Import Users button next to Add User
        const addUserBtn = document.querySelector('[data-bs-target="#addUserModal"]');
        if (addUserBtn) {
            const importBtn = document.createElement('button');
            importBtn.className = 'btn btn-outline-success me-2';
            importBtn.setAttribute('type', 'button');
            importBtn.setAttribute('data-bs-toggle', 'modal');
            importBtn.setAttribute('data-bs-target', '#importUsersModal');
            importBtn.innerHTML = '<i class="fas fa-file-import me-1"></i> Import';
            
            addUserBtn.parentNode.insertBefore(importBtn, addUserBtn);
        }
        
        // Select all users checkbox
        selectAllCheckbox.addEventListener('change', function() {
            userCheckboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
            updateBulkActionButton();
        });
        
        // Individual user checkboxes
        userCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                updateBulkActionButton();
                
                // Uncheck "select all" if any checkbox is unchecked
                if(!this.checked && selectAllCheckbox.checked) {
                    selectAllCheckbox.checked = false;
                }
                
                // Check "select all" if all checkboxes are checked
                if(document.querySelectorAll('.user-checkbox:checked').length === userCheckboxes.length) {
                    selectAllCheckbox.checked = true;
            }
        });
    });

        // Edit user modal setup
        const editUserButtons = document.querySelectorAll('.edit-user-btn');
        editUserButtons.forEach(button => {
            button.addEventListener('click', function() {
                const userId = this.getAttribute('data-user-id');
                const username = this.getAttribute('data-username');
                const email = this.getAttribute('data-email');
                const phone = this.getAttribute('data-phone');
                const department = this.getAttribute('data-department');
                const role = this.getAttribute('data-role');
                
                // Set form action
                document.getElementById('editUserForm').action = `/edit-user/${userId}`;
                
                // Populate form fields
                document.getElementById('editFullName').value = username;
                document.getElementById('editEmail').value = email;
                document.getElementById('editPhone').value = phone || '';
                document.getElementById('editDepartment').value = department;
                document.getElementById('editRole').value = role;
                document.getElementById('editPassword').value = '';
        });
    });

        // Delete user modal setup
        const deleteUserButtons = document.querySelectorAll('.delete-user-btn');
        deleteUserButtons.forEach(button => {
        button.addEventListener('click', function() {
                const userId = this.getAttribute('data-user-id');
                const username = this.getAttribute('data-username');
                
                // Set form action and user name
                document.getElementById('deleteUserForm').action = `/delete-user/${userId}`;
                document.getElementById('deleteUserName').textContent = username;
        });
    });
    
        // Single Reset Password modal setup
        const resetPwdButtons = document.querySelectorAll('.reset-pwd-btn');
        resetPwdButtons.forEach(button => {
        button.addEventListener('click', function() {
                const userId = this.getAttribute('data-user-id');
                const username = this.getAttribute('data-username');
                
                // Set form action and username
                document.getElementById('singleResetPasswordForm').action = `/reset-password/${userId}`;
                document.getElementById('resetPasswordUsername').textContent = username;
        });
    });
    
        // Toggle generate/custom password
        document.getElementById('generatePassword').addEventListener('change', function() {
            document.getElementById('customPasswordField').style.display = this.checked ? 'none' : 'block';
        });

        // Toggle User Status modal setup
        const toggleStatusButtons = document.querySelectorAll('.toggle-status-btn');
        toggleStatusButtons.forEach(button => {
        button.addEventListener('click', function() {
                const userId = this.getAttribute('data-user-id');
                const username = this.getAttribute('data-username');
                const newStatus = this.getAttribute('data-status'); // 'active' or 'inactive'
                
                const title = newStatus === 'active' ? 'Activate User' : 'Deactivate User';
                const message = `Are you sure you want to ${newStatus === 'active' ? 'activate' : 'deactivate'} user <strong>${username}</strong>?`;
                const btnText = newStatus === 'active' ? 'Activate' : 'Deactivate';
                const btnClass = newStatus === 'active' ? 'btn-success' : 'btn-danger';
                
                // Set modal content
                document.getElementById('toggleStatusTitle').textContent = title;
                document.getElementById('toggleStatusMessage').innerHTML = message;
                document.getElementById('toggleStatusAction').value = newStatus === 'active' ? 'activate' : 'deactivate';
                document.getElementById('toggleStatusForm').action = `/toggle-user-status/${userId}`;
                
                const confirmBtn = document.getElementById('confirmToggleStatusBtn');
                confirmBtn.textContent = btnText;
                confirmBtn.className = `btn ${btnClass}`;
        });
    });
    
        // Bulk action buttons
        const bulkActionButtons = document.querySelectorAll('.bulk-action-btn');
        bulkActionButtons.forEach(button => {
            button.addEventListener('click', function() {
                const action = this.getAttribute('data-action');
                document.getElementById('bulkActionType').value = action;
                
                // Populate user lists in modals
                updateSelectedUsersList(action);
            });
        });
        
        // Download template button
        document.getElementById('downloadTemplateBtn').addEventListener('click', function(e) {
                    e.preventDefault();
            
            // Create CSV content
            const csvContent = "Name,Email,Phone,Department,Role\nJohn Doe,john@example.com,123-456-7890,IT,Administrator\nJane Smith,jane@example.com,987-654-3210,HR,User";
            
            // Create a download link
            const encodedUri = encodeURI("data:text/csv;charset=utf-8," + csvContent);
            const link = document.createElement("a");
                    link.setAttribute("href", encodedUri);
            link.setAttribute("download", "user_import_template.csv");
                    document.body.appendChild(link);
            
            // Trigger download and remove link
                    link.click();
                    document.body.removeChild(link);
        });
        
        // Confirm bulk deletion
        document.getElementById('confirmBulkDeleteBtn').addEventListener('click', function() {
            submitBulkAction('delete');
        });
        
        // Confirm bulk role assignment
        document.getElementById('confirmRoleBtn').addEventListener('click', function() {
            const role = document.getElementById('bulkRoleSelect').value;
            // Add role to the form
            const roleInput = document.createElement('input');
            roleInput.type = 'hidden';
            roleInput.name = 'role';
            roleInput.value = role;
            document.getElementById('bulkActionForm').appendChild(roleInput);
            
            submitBulkAction('assign_role');
        });
        
        // Confirm bulk department assignment
        document.getElementById('confirmDepartmentBtn').addEventListener('click', function() {
            const department = document.getElementById('bulkDepartmentSelect').value;
            // Add department to the form
            const deptInput = document.createElement('input');
            deptInput.type = 'hidden';
            deptInput.name = 'department';
            deptInput.value = department;
            document.getElementById('bulkActionForm').appendChild(deptInput);
            
            submitBulkAction('assign_department');
        });
        
        // Confirm password reset
        document.getElementById('confirmResetPasswordBtn').addEventListener('click', function() {
            submitBulkAction('reset-password');
        });

        // Confirm export
        document.getElementById('confirmExportBtn').addEventListener('click', function() {
            // Get export format
            const format = document.getElementById('exportFormat').value;
            
            // Get selected fields
            const fields = Array.from(document.querySelectorAll('input[name="fields"]:checked'))
                .map(checkbox => checkbox.value);
            
            // Add export parameters to the form
            const formatInput = document.createElement('input');
            formatInput.type = 'hidden';
            formatInput.name = 'format';
            formatInput.value = format;
            
            const fieldsInput = document.createElement('input');
            fieldsInput.type = 'hidden';
            fieldsInput.name = 'fields';
            fieldsInput.value = fields.join(',');
            
            const form = document.getElementById('bulkActionForm');
            form.appendChild(formatInput);
            form.appendChild(fieldsInput);
            
            submitBulkAction('export');
        });

        // Confirm send credentials
        document.getElementById('confirmSendCredentialsBtn').addEventListener('click', function() {
            // Get email subject and message
            const subject = document.getElementById('emailSubject').value;
            const message = document.getElementById('emailMessage').value;
            
            // Add parameters to the form
            const subjectInput = document.createElement('input');
            subjectInput.type = 'hidden';
            subjectInput.name = 'subject';
            subjectInput.value = subject;
            
            const messageInput = document.createElement('input');
            messageInput.type = 'hidden';
            messageInput.name = 'message';
            messageInput.value = message;
            
            const form = document.getElementById('bulkActionForm');
            form.appendChild(subjectInput);
            form.appendChild(messageInput);
            
            submitBulkAction('send_credentials');
        });
        
        // Helper functions
        function updateBulkActionButton() {
            const selectedCheckboxes = document.querySelectorAll('.user-checkbox:checked');
            const selectedCount = selectedCheckboxes.length;
            
            if (selectedCount > 0) {
                bulkActionsBtn.removeAttribute('disabled');
                bulkActionsBtn.innerHTML = `<i class="fas fa-tasks me-1"></i> Bulk Actions (${selectedCount})`;
                            } else {
                bulkActionsBtn.setAttribute('disabled', 'disabled');
                bulkActionsBtn.innerHTML = '<i class="fas fa-tasks me-1"></i> Bulk Actions';
            }
        }
        
        function updateSelectedUsersList(action) {
            const selectedUsers = [];
            const selectedIds = [];
            
            document.querySelectorAll('.user-checkbox:checked').forEach(checkbox => {
                selectedUsers.push(checkbox.getAttribute('data-username'));
                selectedIds.push(checkbox.value);
            });
            
            // Update the relevant list based on action
            const listMap = {
                'delete': 'selectedUsersList',
                'assign_role': 'roleUsersList',
                'assign_department': 'departmentUsersList',
                'reset-password': 'resetPasswordUsersList',
                'export': 'exportUsersList',
                'send_credentials': 'credentialsUsersList'
            };
            
            if (listMap[action]) {
                const list = document.getElementById(listMap[action]);
                if (list) {
                    list.innerHTML = '';
                    selectedUsers.forEach(username => {
                        const item = document.createElement('li');
                        item.textContent = username;
                        list.appendChild(item);
            });
        }
    }
    
            // Update hidden input with selected IDs
            bulkUserIdsInput.value = selectedIds.join(',');
        }
        
        function submitBulkAction(action) {
            // Close any open modals
            const modalMap = {
                'delete': 'confirmDelete',
                'assign_role': 'assignRole',
                'assign_department': 'assignDepartment',
                'reset-password': 'resetPassword',
                'export': 'exportUsers',
                'send_credentials': 'sendCredentials'
            };
            
            if (modalMap[action]) {
                const modalId = `${modalMap[action]}Modal`;
                const modalEl = document.getElementById(modalId);
                if (modalEl) {
                    const modal = bootstrap.Modal.getInstance(modalEl);
                    if (modal) modal.hide();
                }
            }
            
            // Submit the form
            document.getElementById('bulkActionForm').submit();
        }
});
</script>
{% endblock %} 
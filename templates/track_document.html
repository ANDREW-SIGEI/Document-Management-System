{% extends 'layout.html' %}

{% block title %}Track Document{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card border-0 shadow">
                <div class="card-header bg-primary text-white">
                    <h1 class="h3 mb-0">Track Document</h1>
                </div>
                <div class="card-body">
                    {% with messages = get_flashed_messages(with_categories=true) %}
                        {% if messages %}
                            {% for category, message in messages %}
                                <div class="alert alert-{{ category }}">{{ message }}</div>
                            {% endfor %}
                        {% endif %}
                    {% endwith %}
                    
                    <p class="text-muted mb-4">Enter the document tracking code to view its current status and history.</p>
                    
                    <form method="POST" action="{{ url_for('track_document') }}">
                        <div class="form-group">
                            <label for="document_code">Document Tracking Code</label>
                            <div class="input-group">
                                <div class="input-group-prepend">
                                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                                </div>
                                <input type="text" class="form-control" id="document_code" name="document_code" 
                                       value="{{ qr_code_value }}"
                                       placeholder="Enter tracking code (e.g., DOC-2023-001)" required>
                                <div class="input-group-append">
                                    <button type="submit" class="btn btn-primary">Track Document</button>
                                </div>
                            </div>
                        </div>
                    </form>
                    
                    <div class="mt-3 text-center">
                        <button id="scanBarcode" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-barcode mr-1"></i> Scan Barcode
                        </button>
                        <button id="scanQrCode" class="btn btn-outline-secondary btn-sm ml-2">
                            <i class="fas fa-qrcode mr-1"></i> Scan QR Code
                        </button>
                        <div id="autoRefreshContainer" class="d-inline-block ml-2" style="display: none !important;">
                            <div class="custom-control custom-switch">
                                <input type="checkbox" class="custom-control-input" id="autoRefresh">
                                <label class="custom-control-label" for="autoRefresh">Auto Refresh</label>
                            </div>
                        </div>
                    </div>
                    
                    <div id="scannerInterface" class="mt-3 p-3 border rounded bg-light text-center" style="display: none;">
                        <div id="scanner-container">
                            <video id="scanner-video" style="width: 100%; max-height: 300px;"></video>
                        </div>
                        <div class="mt-2">
                            <small class="text-muted">Position the barcode/QR code in front of your camera</small>
                            <button id="closeScanner" class="btn btn-sm btn-danger ml-2">
                                <i class="fas fa-times"></i> Close Scanner
                            </button>
                        </div>
                        <div id="scanner-error" class="alert alert-danger mt-2" style="display: none;">
                            <i class="fas fa-exclamation-triangle mr-1"></i>
                            <span id="scanner-error-message">Error accessing camera</span>
                            <br>
                            <small>Make sure you've granted camera permission to this website</small>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <a href="#advancedSearch" data-toggle="collapse" class="text-decoration-none">
                            <i class="fas fa-sliders-h"></i> Advanced Search Options
                        </a>
                        
                        <div id="advancedSearch" class="collapse mt-3">
                            <div class="card card-body bg-light">
                                <form action="{{ url_for('track_document') }}" method="GET">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label for="sender">Sender</label>
                                                <input type="text" class="form-control form-control-sm" id="sender" name="sender" placeholder="Sender name or department">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label for="recipient">Recipient</label>
                                                <input type="text" class="form-control form-control-sm" id="recipient" name="recipient" placeholder="Recipient name or department">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label for="dateRange">Date Range</label>
                                                <select class="form-control form-control-sm" id="dateRange" name="date_range">
                                                    <option value="all">All Time</option>
                                                    <option value="today">Today</option>
                                                    <option value="yesterday">Yesterday</option>
                                                    <option value="this_week">This Week</option>
                                                    <option value="last_week">Last Week</option>
                                                    <option value="this_month">This Month</option>
                                                    <option value="custom">Custom Range...</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label for="status">Status</label>
                                                <select class="form-control form-control-sm" id="status" name="status">
                                                    <option value="all">All Statuses</option>
                                                    <option value="Incoming">Incoming</option>
                                                    <option value="Pending">Pending</option>
                                                    <option value="Received">Received</option>
                                                    <option value="Outgoing">Outgoing</option>
                                                    <option value="Sent">Sent</option>
                                                    <option value="Ended">Ended</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    <div id="customDateRange" style="display: none;">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    <label for="startDate">Start Date</label>
                                                    <input type="date" class="form-control form-control-sm" id="startDate" name="start_date">
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    <label for="endDate">End Date</label>
                                                    <input type="date" class="form-control form-control-sm" id="endDate" name="end_date">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <button type="submit" class="btn btn-sm btn-primary">Search Documents</button>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <h5>What is a tracking code?</h5>
                        <p>A tracking code is a unique identifier assigned to each document in the system. You can use this code to:</p>
                        <ul>
                            <li>View the current status of your document</li>
                            <li>See who is currently handling your document</li>
                            <li>View the document's history and comments</li>
                            <li>Add actions or comments to the document (if authorized)</li>
                        </ul>
                        <p>You can find your document's tracking code in your confirmation email or receipt when you submitted the document.</p>
                    </div>
                    
                    <div class="mt-5 text-center">
                        <hr>
                        <p class="text-muted">Don't have a tracking code?</p>
                        <a href="{{ url_for('compose') }}" class="btn btn-outline-primary">Create New Document</a>
                        <a href="{{ url_for('incoming') }}" class="btn btn-outline-secondary">View All Incoming Documents</a>
                    </div>
                </div>
            </div>
            
            <div class="card border-0 shadow mt-4">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Recent Documents</h5>
                    <div class="btn-group btn-group-sm">
                        <button type="button" class="btn btn-outline-secondary active" data-filter="all">All</button>
                        <button type="button" class="btn btn-outline-secondary" data-filter="database">Database</button>
                        <button type="button" class="btn btn-outline-secondary" data-filter="json">JSON</button>
                    </div>
                </div>
                <div class="card-body p-0">
                    {% if is_search %}
                        <div class="alert alert-info m-3">
                            <h6 class="mb-2">Search Results</h6>
                            <div class="d-flex flex-wrap">
                                {% if search_params.sender %}
                                    <span class="badge badge-secondary mr-2 mb-1">Sender: {{ search_params.sender }}</span>
                                {% endif %}
                                {% if search_params.recipient %}
                                    <span class="badge badge-secondary mr-2 mb-1">Recipient: {{ search_params.recipient }}</span>
                                {% endif %}
                                {% if search_params.status and search_params.status != 'all' %}
                                    <span class="badge badge-secondary mr-2 mb-1">Status: {{ search_params.status }}</span>
                                {% endif %}
                                {% if search_params.date_range and search_params.date_range != 'all' %}
                                    <span class="badge badge-secondary mr-2 mb-1">Date: {{ search_params.date_range|replace('_', ' ')|capitalize }}</span>
                                {% endif %}
                            </div>
                            <div class="mt-2">
                                <a href="{{ url_for('track_document') }}" class="btn btn-sm btn-outline-secondary">
                                    <i class="fas fa-times mr-1"></i> Clear Search
                                </a>
                            </div>
                        </div>
                        
                        <div class="list-group list-group-flush">
                            {% if search_results %}
                                {% for doc in search_results %}
                                    <a href="{{ url_for('track_document_details', document_code=doc.code) if doc.source == 'json' else url_for('document_details', doc_code=doc.code) }}" 
                                    class="list-group-item list-group-item-action document-item" data-source="{{ doc.source }}">
                                        <div class="d-flex w-100 justify-content-between">
                                            <h6 class="mb-1">{{ doc.code }}</h6>
                                            <small class="text-nowrap">{{ doc.timestamp }}</small>
                                        </div>
                                        <p class="mb-1">{{ doc.filename }}</p>
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <span class="badge badge-{% if doc.status == 'Incoming' %}primary{% elif doc.status == 'Pending' %}warning{% elif doc.status == 'Received' %}success{% elif doc.status == 'Outgoing' %}info{% else %}secondary{% endif %}">
                                                    {{ doc.status }}
                                                </span>
                                                <small class="text-muted ml-2">
                                                    {{ doc.sender }} → {{ doc.recipient }}
                                                </small>
                                            </div>
                                            <small class="text-muted">
                                                <span class="badge badge-light">
                                                    <i class="fas fa-{% if doc.source == 'database' %}database{% else %}file-alt{% endif %} mr-1"></i>
                                                    {{ doc.source|capitalize }}
                                                </span>
                                            </small>
                                        </div>
                                    </a>
                                {% endfor %}
                            {% else %}
                                <div class="list-group-item py-4">
                                    <div class="text-center text-muted">
                                        <i class="fas fa-search fa-2x mb-2"></i>
                                        <p>No documents match your search criteria.</p>
                                        <p>Try broadening your search parameters.</p>
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                    {% else %}
                        <div class="list-group list-group-flush">
                            {% for doc in recent_documents[:10] if recent_documents %}
                                <a href="{{ url_for('track_document_details', document_code=doc.code) if doc.source == 'json' else url_for('document_details', doc_code=doc.code) }}" 
                                class="list-group-item list-group-item-action document-item" data-source="{{ doc.source }}">
                                    <div class="d-flex w-100 justify-content-between">
                                        <h6 class="mb-1">{{ doc.code }}</h6>
                                        <small class="text-nowrap">{{ doc.timestamp }}</small>
                                    </div>
                                    <p class="mb-1">{{ doc.filename }}</p>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="badge badge-{% if doc.status == 'Incoming' %}primary{% elif doc.status == 'Pending' %}warning{% elif doc.status == 'Received' %}success{% elif doc.status == 'Outgoing' %}info{% else %}secondary{% endif %}">
                                            {{ doc.status }}
                                        </span>
                                        <small class="text-muted">
                                            <span class="badge badge-light">
                                                <i class="fas fa-{% if doc.source == 'database' %}database{% else %}file-alt{% endif %} mr-1"></i>
                                                {{ doc.source|capitalize }}
                                            </span>
                                        </small>
                                    </div>
                                </a>
                            {% else %}
                                <div class="list-group-item">
                                    <p class="text-center mb-0">No recent documents found</p>
                                </div>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
                <div class="card-footer bg-white text-center">
                    <a href="{{ url_for('dashboard') }}" class="btn btn-sm btn-link">View All Documents</a>
                </div>
            </div>
            
            <div class="card border-0 shadow mt-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Generate QR Code for a Document</h5>
                </div>
                <div class="card-body">
                    <form id="qrGeneratorForm" class="mb-3">
                        <div class="form-group">
                            <label for="qrDocCode">Document Code</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="qrDocCode" name="qrDocCode" 
                                       placeholder="Enter document code for QR generation">
                                <div class="input-group-append">
                                    <button type="submit" class="btn btn-secondary">Generate QR</button>
                                </div>
                            </div>
                            <small class="form-text text-muted">
                                QR codes make document tracking easier via mobile devices.
                            </small>
                        </div>
                    </form>
                    
                    <div id="qrCodeContainer" class="text-center p-3" style="display: none;">
                        <div id="qrcode" class="d-inline-block border p-2 bg-white"></div>
                        <div class="mt-2">
                            <button id="downloadQR" class="btn btn-sm btn-primary">
                                <i class="fas fa-download mr-1"></i> Download
                            </button>
                            <button id="printQR" class="btn btn-sm btn-secondary">
                                <i class="fas fa-print mr-1"></i> Print
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>
<script src="https://unpkg.com/@zxing/library@0.19.1/umd/index.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const filterButtons = document.querySelectorAll('[data-filter]');
        const documentItems = document.querySelectorAll('.document-item');
        
        filterButtons.forEach(button => {
            button.addEventListener('click', function() {
                filterButtons.forEach(btn => btn.classList.remove('active'));
                
                this.classList.add('active');
                
                const filter = this.getAttribute('data-filter');
                
                documentItems.forEach(item => {
                    if (filter === 'all' || item.getAttribute('data-source') === filter) {
                        item.style.display = '';
                    } else {
                        item.style.display = 'none';
                    }
                });
            });
        });
        
        const dateRangeSelect = document.getElementById('dateRange');
        const customDateRange = document.getElementById('customDateRange');
        
        dateRangeSelect.addEventListener('change', function() {
            if (this.value === 'custom') {
                customDateRange.style.display = 'block';
            } else {
                customDateRange.style.display = 'none';
            }
        });
        
        const qrGeneratorForm = document.getElementById('qrGeneratorForm');
        const qrCodeContainer = document.getElementById('qrCodeContainer');
        const qrCodeInput = document.getElementById('qrDocCode');
        let qrCode;
        
        qrGeneratorForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const docCode = qrCodeInput.value.trim();
            
            if (docCode) {
                if (!qrCode) {
                    qrCode = new QRious({
                        element: document.createElement('canvas'),
                        size: 200,
                        value: window.location.origin + '/track_document?code=' + docCode
                    });
                } else {
                    qrCode.value = window.location.origin + '/track_document?code=' + docCode;
                }
                
                const qrContainer = document.getElementById('qrcode');
                qrContainer.innerHTML = '';
                qrContainer.appendChild(qrCode.element);
                qrCodeContainer.style.display = 'block';
            }
        });
        
        document.getElementById('downloadQR').addEventListener('click', function() {
            if (qrCode) {
                const link = document.createElement('a');
                link.download = 'document-qr-' + qrCodeInput.value.trim() + '.png';
                link.href = qrCode.element.toDataURL('image/png');
                link.click();
            }
        });
        
        document.getElementById('printQR').addEventListener('click', function() {
            if (qrCode) {
                const printWindow = window.open('', '_blank');
                printWindow.document.write('<html><head><title>Document QR Code</title>');
                printWindow.document.write('<style>body { text-align: center; } div { margin: 20px; }</style>');
                printWindow.document.write('</head><body>');
                printWindow.document.write('<h3>QR Code for Document: ' + qrCodeInput.value.trim() + '</h3>');
                printWindow.document.write('<div>');
                printWindow.document.write('<img src="' + qrCode.element.toDataURL('image/png') + '" />');
                printWindow.document.write('</div>');
                printWindow.document.write('</body></html>');
                printWindow.document.close();
                printWindow.focus();
                printWindow.print();
                printWindow.close();
            }
        });
        
        // Add clipboard copy button
        const copyQRBtn = document.createElement('button');
        copyQRBtn.id = 'copyQR';
        copyQRBtn.className = 'btn btn-sm btn-info ml-2';
        copyQRBtn.innerHTML = '<i class="fas fa-copy mr-1"></i> Copy';
        document.querySelector('#qrCodeContainer .mt-2').appendChild(copyQRBtn);
        
        document.getElementById('copyQR').addEventListener('click', function() {
            if (qrCode) {
                // Create a temporary canvas
                const canvas = document.createElement('canvas');
                canvas.width = qrCode.element.width;
                canvas.height = qrCode.element.height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(qrCode.element, 0, 0);
                
                // Copy to clipboard (works in some browsers)
                canvas.toBlob(function(blob) {
                    try {
                        navigator.clipboard.write([
                            new ClipboardItem({
                                'image/png': blob
                            })
                        ]).then(() => {
                            alert('QR code copied to clipboard');
                        }).catch(err => {
                            console.error('Error copying QR code: ', err);
                            alert('Could not copy QR code. Your browser may not support this feature.');
                        });
                    } catch (e) {
                        console.error('Error copying QR code: ', e);
                        alert('Could not copy QR code. Your browser may not support this feature.');
                    }
                }, 'image/png');
            }
        });
        
        let codeReader;
        const scanVideo = document.getElementById('scanner-video');
        const scannerInterface = document.getElementById('scannerInterface');
        const scannerError = document.getElementById('scanner-error');
        const scannerErrorMessage = document.getElementById('scanner-error-message');
        
        document.getElementById('scanBarcode').addEventListener('click', function() {
            initializeScanner('barcode');
        });
        
        document.getElementById('scanQrCode').addEventListener('click', function() {
            initializeScanner('qrcode');
        });
        
        document.getElementById('closeScanner').addEventListener('click', function() {
            if (codeReader) {
                codeReader.reset();
                scannerInterface.style.display = 'none';
                scannerError.style.display = 'none';
            }
        });
        
        function initializeScanner(type) {
            scannerInterface.style.display = 'block';
            scannerError.style.display = 'none';
            
            if (!codeReader) {
                codeReader = new ZXing.BrowserMultiFormatReader();
            }
            
            codeReader.listVideoInputDevices()
                .then((videoInputDevices) => {
                    if (videoInputDevices.length > 0) {
                        let selectedDeviceId = videoInputDevices[0].deviceId;
                        
                        codeReader.decodeFromVideoDevice(
                            selectedDeviceId, 
                            'scanner-video',
                            (result, err) => {
                                if (result) {
                                    // Check if result is a URL with code parameter
                                    let code = result.text;
                                    if (code.includes('code=')) {
                                        code = code.split('code=')[1].split('&')[0];
                                    }
                                    
                                    document.getElementById('document_code').value = code;
                                    codeReader.reset();
                                    scannerInterface.style.display = 'none';
                                    
                                    // Auto-submit the form
                                    document.querySelector('form').submit();
                                }
                                
                                if (err && !(err instanceof ZXing.NotFoundException)) {
                                    console.error(err);
                                }
                            }
                        );
                    } else {
                        scannerError.style.display = 'block';
                        scannerErrorMessage.textContent = 'No video input devices found';
                    }
                })
                .catch(err => {
                    console.error(err);
                    scannerError.style.display = 'block';
                    scannerErrorMessage.textContent = 'Error accessing camera: ' + err;
                    scannerInterface.style.display = 'block';
                });
        }
        
        // Auto refresh functionality for tracking
        const urlParams = new URLSearchParams(window.location.search);
        const codeParam = urlParams.get('code');
        
        if (codeParam) {
            // If there's a code in the URL, populate the input
            document.getElementById('document_code').value = codeParam;
            
            // Show auto-refresh control
            document.getElementById('autoRefreshContainer').style.display = 'inline-block !important';
            
            // Check if auto-refresh was previously enabled
            const autoRefresh = document.getElementById('autoRefresh');
            const wasEnabled = localStorage.getItem('documentTrackAutoRefresh') === 'true';
            
            autoRefresh.checked = wasEnabled;
            
            if (wasEnabled) {
                startAutoRefresh();
            }
            
            // Toggle auto-refresh
            autoRefresh.addEventListener('change', function() {
                if (this.checked) {
                    localStorage.setItem('documentTrackAutoRefresh', 'true');
                    startAutoRefresh();
                } else {
                    localStorage.setItem('documentTrackAutoRefresh', 'false');
                    stopAutoRefresh();
                }
            });
        }
        
        let refreshInterval;
        
        function startAutoRefresh() {
            if (!refreshInterval) {
                refreshInterval = setInterval(function() {
                    // Submit the form to refresh data
                    document.querySelector('form').submit();
                }, 60000); // Refresh every minute
            }
        }
        
        function stopAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
            }
        }
    });
</script>
{% endblock %}
{% endblock %} 